
 <!DOCTYPE HTML>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
  
    <title>香蕉的个人博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Hundred Wang">
    

    
    <meta property="og:type" content="website">
<meta property="og:title" content="香蕉的个人博客">
<meta property="og:url" content="http://www.hundredone.win/index.html">
<meta property="og:site_name" content="香蕉的个人博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="香蕉的个人博客">

    
    <link rel="alternative" href="/atom.xml" title="香蕉的个人博客" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/fauthor32.ico">
    
    
    <link rel="apple-touch-icon" href="/img/author114.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/author114.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="香蕉的个人博客" title="香蕉的个人博客"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="香蕉的个人博客">香蕉的个人博客</a></h1>
				<h2 class="blog-motto">用卑微的视角,为浩瀚的科技大海共享一份绵薄之力</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/about">About</a></li>
					
						<li><a href="/tags">tags</a></li>
					
						<li><a href="/categories">categories</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:www.hundredone.win">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/20/IOS黑魔法/IOS黑魔法---XAspect(第三方插件)/" title="iOS开发---XAspect(第三方插件)" itemprop="url">iOS开发---XAspect(第三方插件)</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Hundred Wang" target="_blank" itemprop="author">Hundred Wang</a>
		
  <p class="article-time">
    <time datetime="2016-06-19T22:49:50.000Z" itemprop="datePublished"> 发表于 2016-06-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>首先啥都不说,先放上XAspect的连接:<a href="https://github.com/xareelee/XAspect" target="_blank" rel="external">XAspect</a></p>
<p>参考文章:<a href="http://www.cnblogs.com/wujy/archive/2016/07/07/5651089.html" target="_blank" rel="external">哈哈</a></p>
<blockquote>
<p>背景</p>
</blockquote>
<p>这两天封装个推,遇到一个男人都会遇到的问题,不知道怎么入手,OK,反正都得弄出来,顺便做得漂漂亮亮的…然后故事就开始了…<br>好吧,先把个推的demo下载:<a href="http://www.getui.com/download/docs/iOS/GETUI_IOS_SDK.zip" target="_blank" rel="external">2016-8-15下载地址</a><code>PS:过期了和我说下</code><br>官网登陆地址:<a href="https://dev.getui.com/dos4.0/index.html#app" target="_blank" rel="external">个推官网</a>(注册什么的巴拉巴拉自己弄去,写的很清楚)</p>
<blockquote>
<p>正文开始</p>
<p>作者信息</p>
</blockquote>
<p>如果有不足或者错误的地方还望各位读者批评指正，可以评论留言，笔者收到后第一时间回复。</p>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">具体信息</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">QQ/微信</td>
<td style="text-align:center">hundreda</td>
</tr>
<tr>
<td style="text-align:center">简书号连接</td>
<td style="text-align:center"><a href="http://www.jianshu.com/users/a3ae6d7c68b6/latest_articles" target="_blank" rel="external">iOS-香蕉大大</a></td>
</tr>
<tr>
<td style="text-align:center">GitHub个人开源主页</td>
<td style="text-align:center"><a href="https://github.com/OneHundredSir" target="_blank" rel="external">GitHub连接</a></td>
</tr>
<tr>
<td style="text-align:center">好心人赏我个<code>赞</code></td>
<td style="text-align:center"><code>欢迎各位前来查看，star,感谢各位的阅读</code></td>
</tr>
<tr>
<td style="text-align:center">个人iOS开发QQ讨论群</td>
<td style="text-align:center"><strong>365204530</strong></td>
</tr>
<tr>
<td style="text-align:center"><code>群内规矩</code></td>
<td style="text-align:center"><code>聊天扯淡，讨论技术都行，没有什么群规，不懂就问</code></td>
</tr>
<tr>
<td style="text-align:center">iOS开发类微信订阅号</td>
<td style="text-align:center"><strong>大大家的IOS说</strong></td>
</tr>
<tr>
<td style="text-align:center"><em>微信扫一扫下面二维码</em></td>
<td style="text-align:center"><code>一起用碎片时间学习IOS吧</code></td>
</tr>
</tbody>
</table>
<p><img src="http://upload-images.jianshu.io/upload_images/1730495-755d908f00d77cf8.gif?imageMogr2/auto-orient/strip" alt="微信个人技术订阅号"><br>喜欢的朋友可以赏我2块大洋买糖吃～你的打赏是我前进的动力~一起做一个乐于分享的人吧~</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/iOS进阶/">iOS进阶</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/iOS黑魔法/">iOS黑魔法</a><a href="/tags/blockKit/">blockKit</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/20/IOS黑魔法/[IOS黑魔法]---使用jspatch热更新(使用篇)含demo/" title="使用jspatch热更新(使用篇)含demo" itemprop="url">使用jspatch热更新(使用篇)含demo</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Hundred Wang" target="_blank" itemprop="author">Hundred Wang</a>
		
  <p class="article-time">
    <time datetime="2016-06-19T22:49:50.000Z" itemprop="datePublished"> 发表于 2016-06-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>如果对JSpatch不了解的朋友请先看我的这一篇:<br><a href="http://www.jianshu.com/p/1e2ff5e0fa2f" target="_blank" rel="external">使用jspatch热更新</a></p>
<h2 id="例子一-用tableView对比一个用jspatch修复bug"><a href="#例子一-用tableView对比一个用jspatch修复bug" class="headerlink" title="例子一:用tableView对比一个用jspatch修复bug"></a>例子一:用tableView对比一个用jspatch修复bug</h2><hr>
<p><a href="https://github.com/OneHundredSir/Objective-C/tree/master/JSPatch/%E9%A6%99%E8%95%89%E5%A4%A7%E5%A4%A7jsPatchDemo" target="_blank" rel="external">Demo下载地址</a></p>
<blockquote>
<p><strong>正常</strong>源代码如下:</p>
</blockquote>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad &#123;</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="keyword">self</span>.dataArray = [<span class="built_in">NSMutableArray</span> arrayWithObjects:<span class="string">@"one"</span>,<span class="string">@"two"</span>,<span class="string">@"three"</span>,<span class="string">@"four"</span>,<span class="string">@"five"</span>, <span class="literal">nil</span>];</div><div class="line">    </div><div class="line"><span class="meta">#pragma mark datasource</span></div><div class="line">- (<span class="built_in">NSInteger</span>)tableView:(<span class="built_in">UITableView</span> *)tableView numberOfRowsInSection:(<span class="built_in">NSInteger</span>)section&#123;</div><div class="line">    <span class="keyword">return</span> <span class="number">5</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (<span class="built_in">UITableViewCell</span>*)tableView:(<span class="built_in">UITableView</span> *)tableView cellForRowAtIndexPath:(<span class="built_in">NSIndexPath</span> *)indexPath&#123;</div><div class="line">    <span class="keyword">static</span> <span class="built_in">NSString</span>* cellIdentifier=<span class="string">@"cell"</span>;</div><div class="line">    <span class="built_in">UITableViewCell</span>* cell=[tableView dequeueReusableCellWithIdentifier:cellIdentifier];</div><div class="line">    <span class="keyword">if</span> (cell==<span class="literal">nil</span>) &#123;</div><div class="line">        cell=[[<span class="built_in">UITableViewCell</span> alloc] initWithStyle:<span class="built_in">UITableViewCellStyleDefault</span> reuseIdentifier:cellIdentifier];</div><div class="line">    &#125;</div><div class="line">    cell.textLabel.text=[<span class="keyword">self</span>.dataArray objectAtIndex:indexPath.row];</div><div class="line">    <span class="keyword">return</span> cell;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://ww4.sinaimg.cn/mw690/006yX0Ypgw1f9puq6nuw5j30yg0iuwkw.jpg" alt="正常展示图示"></p>
<h3 id="崩溃源代码以及整改如下"><a href="#崩溃源代码以及整改如下" class="headerlink" title="崩溃源代码以及整改如下:"></a><strong>崩溃</strong>源代码以及整改如下:</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">-</span> (NSInteger)<span class="selector-tag">tableView</span><span class="selector-pseudo">:(UITableView</span> *)<span class="selector-tag">tableView</span> <span class="selector-tag">numberOfRowsInSection</span><span class="selector-pseudo">:(NSInteger)section</span>&#123;</div><div class="line">    return 10;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><img src="http://ww4.sinaimg.cn/mw690/006yX0Ypgw1f9puq7anbtj30ku09pq5k.jpg" alt="数组越界提示"></p>
<p><img src="http://ww2.sinaimg.cn/mw690/006yX0Ypgw1f9pusnhwocg30z40hh4h5.gif" alt="动态演示"></p>
<p><strong>使用JSpatch修复</strong><a href="http://bang590.github.io/JSPatchConvertor/" target="_blank" rel="external">OC转JS的网页</a><br><a href="https://github.com/OneHundredSir/Objective-C/tree/master/JSPatch/%E9%A6%99%E8%95%89%E5%A4%A7%E5%A4%A7jsPatchDemo" target="_blank" rel="external">Demo下载地址</a><br>JS代码如下(随意用个文本编辑都可以,只要保存的文件后缀为<code>.js</code>,例如<code>hundred.js</code>)<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"> <span class="selector-tag">defineClass</span>("<span class="selector-tag">ViewController</span>", &#123;</div><div class="line">         <span class="attribute">tableView_cellForRowAtIndexPath</span>: <span class="built_in">function</span>(tableView, indexPath) &#123;</div><div class="line">         var cell = tableView.<span class="built_in">dequeueReusableCellWithIdentifier</span>(<span class="string">"cell"</span>)</div><div class="line">         if (!cell) &#123;</div><div class="line">         cell = <span class="built_in">require</span>(<span class="string">'UITableViewCell'</span>).<span class="built_in">alloc</span>().<span class="built_in">initWithStyle_reuseIdentifier</span>(0, <span class="string">"cell"</span>)</div><div class="line">         &#125;</div><div class="line">         <span class="selector-tag">cell</span><span class="selector-class">.textLabel</span>()<span class="selector-class">.setText</span>("1")</div><div class="line">         <span class="selector-tag">return</span> <span class="selector-tag">cell</span></div><div class="line">         &#125;,</div><div class="line">&#125;</div><div class="line">)</div></pre></td></tr></table></figure></p>
<p>接下来就在<code>delegate</code>里面分别实现<strong>本地</strong>以及<strong>网络同步</strong>了<br><a href="https://github.com/OneHundredSir/Objective-C/tree/master/JSPatch/%E9%A6%99%E8%95%89%E5%A4%A7%E5%A4%A7jsPatchDemo" target="_blank" rel="external">Demo下载地址</a></p>
<blockquote>
<p><strong>本地</strong></p>
</blockquote>
<p>代码如下<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">-</span> (BOOL)<span class="selector-tag">application</span><span class="selector-pseudo">:(UIApplication</span> *)<span class="selector-tag">application</span> <span class="selector-tag">didFinishLaunchingWithOptions</span><span class="selector-pseudo">:(NSDictionary</span> *)<span class="selector-tag">launchOptions</span> &#123;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="comment">//JSPatchKey本地测试</span></div><div class="line">    <span class="selector-attr">[JSPatch testScriptInBundle]</span>;</div><div class="line">    <span class="selector-attr">[JSPatch sync]</span>;</div><div class="line">    return YES;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://ww4.sinaimg.cn/mw690/006yX0Ypgw1f9pusom646j30yg0k70zl.jpg" alt="本地测试"></p>
<blockquote>
<p><strong>网络同步</strong><br>1.版本号一致<br>2.上传到App修复–<a href="http://jspatch.com/" target="_blank" rel="external">官网登陆</a></p>
</blockquote>
<p>代码如下<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//这个是后台获取的,改成自己的~</span></div><div class="line"><span class="keyword">static</span> <span class="built_in">NSString</span> *JSPatchKey = <span class="string">@"20e5c016a6b9f7bc"</span>;</div><div class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application didFinishLaunchingWithOptions:(<span class="built_in">NSDictionary</span> *)launchOptions &#123;</div><div class="line">    <span class="comment">//JSPatchKey是创建App获得的AppKey</span></div><div class="line"><span class="comment">//    [JSPatch startWithAppKey:JSPatchKey];</span></div><div class="line">    [JSPatch sync];</div><div class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><img src="http://ww2.sinaimg.cn/mw690/006yX0Ypgw1f9pusr90u6j30x10i07cb.jpg" alt="同步要求的条件"></p>
<h2 id="例子二-给tableView添加按钮事件"><a href="#例子二-给tableView添加按钮事件" class="headerlink" title="例子二:给tableView添加按钮事件"></a>例子二:给tableView添加按钮事件</h2><hr>
<p>OC转JS工具:<a href="http://bang590.github.io/JSPatchConvertor/" target="_blank" rel="external">OC转JS在线</a><br>这里不再去演示怎么使用本地和网络了,直接吧修改的jspatch源码放上来<br>Demo地址:<a href="https://github.com/OneHundredSir/Objective-C/tree/master/JSPatch/%E9%A6%99%E8%95%89%E5%A4%A7%E5%A4%A7%E6%B7%BB%E5%8A%A0%E6%8C%89%E9%94%AE%E5%8A%9F%E8%83%BD" target="_blank" rel="external">点我进入demo下载,记得给我点个star</a><br>JSPatch的源码<br><figure class="highlight http"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"> </div><div class="line"></div><div class="line"><span class="markdown"><span class="section">## 例子二:重构整个函数</span></span></div><div class="line">---</div><div class="line">OC转JS工具:[<span class="string">OC转JS在线</span>](<span class="link">http://bang590.github.io/JSPatchConvertor/</span>)</div><div class="line">这里不再去演示怎么使用本地和网络了,直接吧修改的jspatch源码放上来</div><div class="line">Demo地址:[<span class="string">点我进入demo下载,记得给我点个star</span>](<span class="link"></span>)</div></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//  作者:香蕉大大  简书地址：http://www.jianshu.com/users/a3ae6d7c68b6/latest_articles</span></div><div class="line"><span class="comment">//  微信个人技术公众号：大大家的IOS说（一起用碎片时间学习最新最有用的IOS资料）</span></div><div class="line"><span class="comment">//  微信个人账号：hundreda</span></div><div class="line"></div><div class="line"> defineClass(<span class="string">"ViewController"</span>, &#123;</div><div class="line">         tableView_cellForRowAtIndexPath: <span class="function"><span class="keyword">function</span>(<span class="params">tableView, indexPath</span>) </span>&#123;</div><div class="line">         <span class="keyword">var</span> cell = tableView.dequeueReusableCellWithIdentifier(<span class="string">"cell"</span>)</div><div class="line">         <span class="keyword">if</span> (!cell) &#123;</div><div class="line">         cell = <span class="built_in">require</span>(<span class="string">'UITableViewCell'</span>).alloc().initWithStyle_reuseIdentifier(<span class="number">0</span>, <span class="string">"cell"</span>)</div><div class="line">         &#125;</div><div class="line">         cell.textLabel().setText(<span class="string">"1"</span>)</div><div class="line">         <span class="keyword">return</span> cell</div><div class="line">         &#125;,</div><div class="line">&#125;</div><div class="line">)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"> <span class="built_in">require</span>(<span class="string">'UIAlertView'</span>);</div><div class="line">defineClass(<span class="string">'ViewController'</span>, &#123;</div><div class="line">    tableView_didSelectRowAtIndexPath: <span class="function"><span class="keyword">function</span>(<span class="params">tableView, indexPath</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> alert = UIAlertView.alloc().initWithTitle_message_delegate_cancelButtonTitle_otherButtonTitles(<span class="string">"提示"</span>, <span class="string">"恭喜弹出"</span>, <span class="literal">null</span>, <span class="string">"确定"</span>, <span class="literal">null</span>);</div><div class="line">        alert.show();</div><div class="line">    &#125;,</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><img src="http://ww2.sinaimg.cn/mw690/006yX0Ypgw1f9pusnhwocg30z40hh4h5.gif" alt="添加了按钮提示框"></p>
<blockquote>
<p>不能使用的OC语句</p>
</blockquote>
<p>目前测试不能使用的</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//NSLog不能识别</span></div><div class="line">NSLog(@<span class="string">"我是香蕉大大"</span>);</div><div class="line"></div><div class="line"><span class="comment">//printf不能识别</span></div><div class="line"><span class="built_in">printf</span>(<span class="string">"我是香蕉大大"</span>)</div><div class="line"></div><div class="line"><span class="comment">//arcrandom</span></div><div class="line">随机数也不可以使用~</div></pre></td></tr></table></figure>
<blockquote>
<p>作者信息</p>
</blockquote>
<p>如果有不足或者错误的地方还望各位读者批评指正，可以评论留言，笔者收到后第一时间回复。<strong>允许转载,转载后请给在评论区留下转载地址,转载时请注明出处,否则保留追究权利~</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">具体信息</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">QQ/微信</td>
<td style="text-align:center">hundreda</td>
</tr>
<tr>
<td style="text-align:center">简书号连接</td>
<td style="text-align:center"><a href="http://www.jianshu.com/users/a3ae6d7c68b6/latest_articles" target="_blank" rel="external">iOS-香蕉大大</a></td>
</tr>
<tr>
<td style="text-align:center">GitHub个人开源主页</td>
<td style="text-align:center"><a href="https://github.com/OneHundredSir" target="_blank" rel="external">GitHub连接</a></td>
</tr>
<tr>
<td style="text-align:center">好心人赏我个<code>赞</code></td>
<td style="text-align:center"><code>欢迎各位前来查看，star,感谢各位的阅读</code></td>
</tr>
<tr>
<td style="text-align:center">个人iOS开发QQ讨论群</td>
<td style="text-align:center"><strong>365204530</strong></td>
</tr>
<tr>
<td style="text-align:center"><code>群内规矩</code></td>
<td style="text-align:center"><code>聊天扯淡，讨论技术都行，没有什么群规，不懂就问</code></td>
</tr>
<tr>
<td style="text-align:center">iOS开发类微信订阅号</td>
<td style="text-align:center"><strong>大大家的IOS说</strong></td>
</tr>
<tr>
<td style="text-align:center"><em>微信扫一扫下面二维码</em></td>
<td style="text-align:center"><code>一起用碎片时间学习IOS吧</code></td>
</tr>
</tbody>
</table>
<p><img src="http://upload-images.jianshu.io/upload_images/1730495-755d908f00d77cf8.gif?imageMogr2/auto-orient/strip" alt="微信个人技术订阅号"><br>喜欢的朋友可以赏我2块大洋买糖吃～你的打赏是我前进的动力~一起做一个乐于分享的人吧~</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/iOS进阶/">iOS进阶</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/iOS黑魔法/">iOS黑魔法</a><a href="/tags/iOS进阶拓展/">iOS进阶拓展</a><a href="/tags/iOS热更新/">iOS热更新</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/20/IOS黑魔法/[IOS黑魔法]---使用jspatch热更新(介绍篇)/" title="使用jspatch热更新(介绍篇)" itemprop="url">使用jspatch热更新(介绍篇)</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Hundred Wang" target="_blank" itemprop="author">Hundred Wang</a>
		
  <p class="article-time">
    <time datetime="2016-06-19T22:49:50.000Z" itemprop="datePublished"> 发表于 2016-06-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>感谢JSpatch:<a href="http://jspatch.com/" target="_blank" rel="external">官网地址</a>  作者的github原文:<a href="https://github.com/OneHundredSir/JSPatch" target="_blank" rel="external">github</a><br>本篇只是一个介绍,具体实现请转到我的另一篇文章看具体操作:<br><a href="http://www.jianshu.com/p/19d198dfccaf" target="_blank" rel="external">使用jspatch热更新(实用Demo篇)</a></p>
<h1 id="JSPatch是什么"><a href="#JSPatch是什么" class="headerlink" title="JSPatch是什么"></a>JSPatch是什么</h1><hr>
<p><strong>JSPatch</strong>是一个开源项目，只需要在项目里引入极小的引擎文件，就可以使用 JavaScript 调用任何 Objective-C 的原生接口，替换任意 Objective-C 原生方法。目前主要用于下发 JS 脚本替换原生 Objective-C 代码，实时修复线上 bug.</p>
<h1 id="JSPatch接入"><a href="#JSPatch接入" class="headerlink" title="JSPatch接入"></a>JSPatch接入</h1><hr>
<h2 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h2><p><strong>1. 注册jspatch账号并登录.(<a href="http://www.jspatch.com" target="_blank" rel="external">http://www.jspatch.com</a>).</strong><br>      添加应用,获取appKey</p>
<p><img src="http://ww3.sinaimg.cn/mw690/006yX0Ypgw1f9pv12b6ibg30z40hhgr2.gif" alt="登陆获取appkey"></p>
<p><strong>2. 在”我的app”中添加新的app,未上线项目无需填写AppStoreID,添加完成后可以看到appKey.</strong><br><strong>3. 导入framework和相关类库</strong><br>在官网下载SDK,将解压得到的  <code>JSPatch.framework</code>  导入到项目,并添加依赖的类库:<code>libz.tbd</code>和<code>JavaScriptCore.framework</code>即可.</p>
<p><img src="http://ww1.sinaimg.cn/mw690/006yX0Ypgw1f9pv13p4p6j30sa0awn0f.jpg" alt="添加libz.tbd和JavaScriptCore.framework"></p>
<p><strong>4. 测试补丁和发布补丁</strong><br><strong>本地测试</strong>:新建一个main.js文件,在这个文件中编写js代码(用于替换oc代码的),这个main.js文件如果在项目中,通过<code>[JSPatch testScriptInBundle]</code>;</p>
<p><img src="http://ww2.sinaimg.cn/mw690/006yX0Ypgw1f9pv14d0tbj30yg0jggqr.jpg" alt="本地测试"></p>
<p><strong>在线更新</strong>:方法测试补丁,补丁测试通过后,可以将这个main.js文件上传到jspatch官网,通过<code>[JSPatch startWithAppKey:@&quot;APPKey&quot;]</code>;方法调用在线补丁,项目中的appDelega.m文件中的代理方法中写入这个方法,发布的app每次启动时会在线查找补丁,如果有版本号一致的补丁,则会下载这个补丁,用来替换相应的方法.</p>
<p><img src="http://ww3.sinaimg.cn/mw690/006yX0Ypgw1f9pv1846etg30z40hxe4o.gif" alt="在线热更性"></p>
<p><strong>5. 发布补丁包</strong><br> 在app管理中”新建版本”,新建版本后,上传main.js文件再点击提交即可.需要注意的是新建版本中的版本,对应项目的版本号,app在线上寻找补丁时,版本号是一个筛选条件.</p>
<h2 id="具体例子请看"><a href="#具体例子请看" class="headerlink" title="具体例子请看"></a>具体例子请看</h2><hr>
<blockquote>
<p><a href="http://www.jianshu.com/p/19d198dfccaf" target="_blank" rel="external">使用jspatch热更新(实用Demo篇)</a></p>
</blockquote>
<h2 id="安全问题"><a href="#安全问题" class="headerlink" title="安全问题"></a>安全问题</h2><hr>
<p><strong>传输安全</strong><br>JSPatch脚本的执行权限很高，若在传输过程中被中间人篡改，会带来很大的安全问题，为了防止这种情况出现，我们在传输过程中对JS文件进行了RSA签名加密，流程如下：<br>服务端：<br>计算 JS 文件 MD5 值。<br>用 RSA 私钥对 MD5 值进行加密，与JS文件一起下发给客户端。<br>客户端：<br>拿到加密数据，用 RSA 公钥解密出 MD5 值。<br>本地计算返回的 JS 文件 MD5 值。<br>对比上述的两个 MD5 值，若相等则校验通过，取 JS 文件保存到本地。<br>由于 RSA 是非对称加密，在没有私钥的情况下第三方无法加密对应的 MD5 值，也就无法伪造 JS 文件，杜绝了 JS 文件在传输过程被篡改的可能。</p>
<p><strong>本地存储</strong><br>本地存储的脚本被篡改的机会小很多，只在越狱机器上有点风险，对此 JSPatch SDK 在下载完脚本保存到本地时也进行了简单的对称加密，每次读取时解密。</p>
<h2 id="常见问题-发布补丁后不起作用"><a href="#常见问题-发布补丁后不起作用" class="headerlink" title="常见问题:发布补丁后不起作用"></a>常见问题:发布补丁后不起作用</h2><hr>
<p>原因可能有:</p>
<ol>
<li>APPKey写错了(好好检查).<br><code>错误信息:JSPatch: request success {error = &quot;Document not found&quot;;}</code></li>
<li>发布的版本号和项目的版本号不一致(一定要一致,1.2版本的项目只能用1.2版本的补丁包)<br><code>错误信息:JSPatch: request success {error = &quot;Document not found&quot;;}</code></li>
<li>main.js文件错误,是否找对了”类”和”方法”(类名和方法名要是写错,补丁想起作用也做不到啊)<br><code>错误信息:不会出现任何&quot;JSPatch: request success {}&quot;提示</code></li>
<li>main.js文件语法错误(main.js文件中的js语法错误,或者是oc方法名错误都会导致编译不通过,从而不执行main.js方法,最可怕的是他还不报错,jspatch的原则是,js文件能用就用,不能用,我不告诉你,就是不用.)(一个很长的oc方法转写成js方法是,是没有提示的,一个字母写错了,整个js文件就废了,最关键的是,这些错误的是隐形的,不提示,难发觉,更难找,所以我建议两点,第一,写补丁时现在本地测试,在本地的main.js文件中写一行测试一行,保证每一行都是正确的.第二,把要改的oc代码,暂时copy到main.js文件中,这样,当你在js中写oc的方法名时,而这个方法名在你copy的那段代码中,xcode就会给提示.)<br><code>错误信息:输出成功信息JSPatch: request success {v = 1;},但是依然执行oc代码而不是js代码</code></li>
</ol>
<blockquote>
<p>作者信息</p>
</blockquote>
<p>如果有不足或者错误的地方还望各位读者批评指正，可以评论留言，笔者收到后第一时间回复。<strong>允许转载,转载后请给在评论区留下转载地址,转载时请注明出处,否则保留追究权利~</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">具体信息</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">QQ/微信</td>
<td style="text-align:center">hundreda</td>
</tr>
<tr>
<td style="text-align:center">简书号连接</td>
<td style="text-align:center"><a href="http://www.jianshu.com/users/a3ae6d7c68b6/latest_articles" target="_blank" rel="external">iOS-香蕉大大</a></td>
</tr>
<tr>
<td style="text-align:center">GitHub个人开源主页</td>
<td style="text-align:center"><a href="https://github.com/OneHundredSir" target="_blank" rel="external">GitHub连接</a></td>
</tr>
<tr>
<td style="text-align:center">好心人赏我个<code>赞</code></td>
<td style="text-align:center"><code>欢迎各位前来查看，star,感谢各位的阅读</code></td>
</tr>
<tr>
<td style="text-align:center">个人iOS开发QQ讨论群</td>
<td style="text-align:center"><strong>365204530</strong></td>
</tr>
<tr>
<td style="text-align:center"><code>群内规矩</code></td>
<td style="text-align:center"><code>聊天扯淡，讨论技术都行，没有什么群规，不懂就问</code></td>
</tr>
<tr>
<td style="text-align:center">iOS开发类微信订阅号</td>
<td style="text-align:center"><strong>大大家的IOS说</strong></td>
</tr>
<tr>
<td style="text-align:center"><em>微信扫一扫下面二维码</em></td>
<td style="text-align:center"><code>一起用碎片时间学习IOS吧</code></td>
</tr>
</tbody>
</table>
<p><img src="http://upload-images.jianshu.io/upload_images/1730495-755d908f00d77cf8.gif?imageMogr2/auto-orient/strip" alt="微信个人技术订阅号"><br>喜欢的朋友可以赏我2块大洋买糖吃～你的打赏是我前进的动力~一起做一个乐于分享的人吧~</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/iOS进阶/">iOS进阶</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/iOS黑魔法/">iOS黑魔法</a><a href="/tags/iOS进阶拓展/">iOS进阶拓展</a><a href="/tags/iOS热更新/">iOS热更新</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/20/IOS黑魔法/[IOS黑魔法]---语法糖(简单却不那么简单)/" title="语法糖(简单却不那么简单)" itemprop="url">语法糖(简单却不那么简单)</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Hundred Wang" target="_blank" itemprop="author">Hundred Wang</a>
		
  <p class="article-time">
    <time datetime="2016-06-19T22:49:50.000Z" itemprop="datePublished"> 发表于 2016-06-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <blockquote>
<p>开发过程中我特别喜欢用语法糖,原因很简单,懒得看到一堆长长的代码,但是语法糖我今天无意中看到更有意思的玩法.这里暂时吧把今天新学到的知识点整理一下希望大家喜欢,如果有更好的补充希望能和我说下,我希望更更加好的完善.</p>
</blockquote>
<p><code>语法糖（Syntactic sugar</code>），也译为<code>糖衣语法</code>，是由英国计算机科学家彼得·约翰·兰达（Peter J. Landin）发明的一个术语，指计算机语言中添加的某种语法，这种语法对语言的功能并没有影响，但是更方便程序员使用。通常来说使用语法糖能够增加程序的可读性，从而减少程序代码出错的机会。</p>
<p>本文的目录如下</p>
<ul>
<li><p>OC语法糖</p>
<ul>
<li><code>基础</code>@[],@{}用法在NSArray,NSDictionary,NSNumber使用</li>
<li><code>!重点!</code>@()使用</li>
<li><code>!重点!</code>语法糖在UI中的使用方法</li>
</ul>
</li>
<li><p>swift</p>
<ul>
<li><code>基础</code>if let 与 guard 语法糖</li>
<li><code>基础</code>语法糖Selector例子</li>
</ul>
</li>
</ul>
<h1 id="OC语法糖"><a href="#OC语法糖" class="headerlink" title="OC语法糖"></a>OC语法糖</h1><hr>
<h2 id="常用基础使用部分-这两部分的用法"><a href="#常用基础使用部分-这两部分的用法" class="headerlink" title="常用基础使用部分@[],@{}这两部分的用法"></a>常用基础使用部分@[],@{}这两部分的用法</h2><h2 id="1-一般数组的初始化和访问数组元素是这样的在之前的博客中我是这样初始化NSArray的："><a href="#1-一般数组的初始化和访问数组元素是这样的在之前的博客中我是这样初始化NSArray的：" class="headerlink" title="1.一般数组的初始化和访问数组元素是这样的在之前的博客中我是这样初始化NSArray的："></a><strong>1.一般数组的初始化和访问数组元素是这样的在之前的博客中我是这样初始化NSArray的：</strong></h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">//NSArray的便利初始化</span></div><div class="line"> <span class="built_in">NSArray</span> *array1 = [[<span class="built_in">NSArray</span> alloc] initWithObjects:<span class="string">@"aaa"</span>, <span class="string">@"bbb"</span>, <span class="string">@"ccc"</span>, <span class="literal">nil</span>];</div><div class="line"> <span class="comment">//NSArray的便利构造器</span></div><div class="line"> <span class="built_in">NSArray</span> *array2 = [<span class="built_in">NSArray</span> arrayWithObjects:<span class="string">@"111"</span>, <span class="string">@"222"</span>, <span class="string">@"333"</span>, <span class="literal">nil</span>];</div></pre></td></tr></table></figure>
<p>获取数组的元素</p>
<figure class="highlight mel"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//获取相应索引的元素</span></div><div class="line">id element = [array1 objectAtIndex:<span class="number">0</span>];</div><div class="line">NSLog(@"array1_count = %d, array[<span class="number">0</span>] = %@<span class="string">", count, element);</span></div></pre></td></tr></table></figure>
<p>简化后的数组初始化和访问的做法如下<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">         <span class="comment">//NSArray的定义</span></div><div class="line">         NSArray *<span class="built_in">array</span> = @[@<span class="string">"lu"</span>, @<span class="string">"da"</span>, @<span class="string">"shi"</span>, @YES, @<span class="number">123</span>];</div><div class="line">         <span class="keyword">int</span> count = (<span class="keyword">int</span>)[<span class="built_in">array</span> count];</div><div class="line"></div><div class="line">         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++)</div><div class="line">         &#123;</div><div class="line">             NSLog(@<span class="string">"%@"</span>, <span class="built_in">array</span>[i]);</div><div class="line">         &#125;</div></pre></td></tr></table></figure></p>
<hr>
<h2 id="2-对字典（NSDictionary）的简化也引用我之前博客中得一段代码吧"><a href="#2-对字典（NSDictionary）的简化也引用我之前博客中得一段代码吧" class="headerlink" title="2.对字典（NSDictionary）的简化也引用我之前博客中得一段代码吧"></a><strong>2.对字典（NSDictionary）的简化也引用我之前博客中得一段代码吧</strong></h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//不可变字典的初始化</span></div><div class="line"><span class="built_in">NSDictionary</span> *dictionay = [<span class="built_in">NSDictionary</span> dictionaryWithObjectsAndKeys:<span class="string">@"value1"</span>, <span class="string">@"key1"</span>, <span class="string">@"value2"</span>, <span class="string">@"key2"</span>, <span class="literal">nil</span>];</div><div class="line"><span class="keyword">id</span> value = [dictionay objectForKey:<span class="string">@"key1"</span>];</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"key1 =&gt; %@"</span>, value);</div></pre></td></tr></table></figure>
<p>我们还可以这样做<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//NSDictionary的定义简化</span></div><div class="line"><span class="built_in">NSDictionary</span> *dictionary = @&#123;</div><div class="line">                             <span class="string">@"key0"</span> : <span class="string">@"value0"</span>,</div><div class="line">                             <span class="string">@"key1"</span> : <span class="string">@"value1"</span>,</div><div class="line">                             <span class="string">@"key2"</span> : <span class="string">@"value2"</span></div><div class="line">                             &#125;;</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"key2 =&gt; %@"</span>, dictionary[<span class="string">@"key2"</span>]);</div></pre></td></tr></table></figure></p>
<h2 id="3-对NSNumber简化"><a href="#3-对NSNumber简化" class="headerlink" title="3.对NSNumber简化"></a><strong>3.对NSNumber简化</strong></h2><p>我们可以这样做<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">​    ​    ​    ​把基本类型包装成对象的便利构造函数</div><div class="line"></div><div class="line">​    ​    ​    ​    ​-(<span class="keyword">id</span>) initWithChar : (<span class="keyword">char</span>) value;</div><div class="line"></div><div class="line">​    ​    ​    ​    ​-(<span class="keyword">id</span>) initWithInt : (<span class="keyword">int</span>) value;</div><div class="line"></div><div class="line">​    ​    ​    ​    ​-(<span class="keyword">id</span>) initWithFloat : (<span class="keyword">float</span>) value;</div><div class="line"></div><div class="line">​    ​    ​    ​    ​-(<span class="keyword">id</span>) initWithBool: (<span class="built_in">BOOL</span>) value;</div><div class="line"></div><div class="line">​    ​    ​    ​把基本数据类型包装成对象的便利构造器</div><div class="line"></div><div class="line">​    ​    ​    ​    ​+(<span class="keyword">id</span>) numberWithChar : (<span class="keyword">char</span>) value;</div><div class="line"></div><div class="line">​    ​    ​    ​    ​+(<span class="keyword">id</span>) numberWithInt : (<span class="keyword">int</span>) value;</div><div class="line"></div><div class="line">​    ​    ​    ​    ​+(<span class="keyword">id</span>) numberWithFloat : (<span class="keyword">float</span>) value;</div><div class="line"></div><div class="line">​    ​    ​    ​    ​+(<span class="keyword">id</span>) numberWithBool : (<span class="built_in">BOOL</span>) value;</div></pre></td></tr></table></figure></p>
<p>我们也可以这样做，说明：在char转换为NSNumber是存的是ASCII码的形式，c输出为97<br><figure class="highlight mel"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//NSNumber的简化</span></div><div class="line">NSNumber *a = @123;</div><div class="line">NSNumber *b = @11<span class="number">.2</span>;</div><div class="line">NSNumber *c = @(<span class="string">'a'</span>);</div><div class="line">NSLog(@"a = %@, b = %@, c = %@<span class="string">", a, b, c);</span></div></pre></td></tr></table></figure></p>
<h2 id="针对以上部分的简单练习"><a href="#针对以上部分的简单练习" class="headerlink" title="针对以上部分的简单练习"></a><strong>针对以上部分的简单练习</strong></h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//NSNumber的语法糖</span></div><div class="line">    <span class="built_in">NSNumber</span> *intNumber = [<span class="built_in">NSNumber</span> numberWithInt:<span class="number">100</span>];</div><div class="line">    <span class="built_in">NSNumber</span> *intNumber2 = @<span class="number">100</span>;</div><div class="line">   <span class="comment">//不可变字符串的语法糖</span></div><div class="line">    <span class="built_in">NSString</span> *string = <span class="string">@"hanjunqiang"</span>;</div><div class="line">    <span class="comment">//可变字符串的语法糖</span></div><div class="line">    <span class="built_in">NSMutableString</span> *mString = <span class="string">@"大爱中华"</span>.mutableCopy;<span class="comment">//后缀不能丢</span></div><div class="line">    </div><div class="line">    <span class="comment">//不可变数组的语法糖</span></div><div class="line">    <span class="built_in">NSArray</span> *array = @[<span class="string">@"1"</span>,<span class="string">@"2"</span>,<span class="string">@"3"</span>,<span class="string">@"4"</span>];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,array);</div><div class="line">    </div><div class="line">    <span class="comment">//访问数组元素的语法糖</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,array[<span class="number">1</span>]);</div><div class="line">    </div><div class="line">    <span class="comment">//可变数组的语法糖</span></div><div class="line">    <span class="built_in">NSMutableArray</span> *mArray = @[<span class="string">@"1"</span>,<span class="string">@"2"</span>,<span class="string">@"3"</span>,<span class="string">@"4"</span>].mutableCopy;</div><div class="line">  </div><div class="line">    <span class="comment">//字典的语法糖</span></div><div class="line">    <span class="comment">//字典对象[key值]取出对应的value值</span></div><div class="line">    <span class="built_in">NSDictionary</span> *dict = @&#123;<span class="string">@"a"</span>:<span class="string">@"1"</span>,<span class="string">@"b"</span>:<span class="string">@"2"</span>&#125;;<span class="comment">//key值在冒号前，value值在冒号后</span></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,dict);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,dict[<span class="string">@"a"</span>]);</div><div class="line"> <span class="comment">//可变字典可以赋值和修改值</span></div><div class="line">    <span class="built_in">NSMutableDictionary</span> *mDic = @&#123;<span class="string">@"a"</span>:<span class="string">@"1"</span>,<span class="string">@"b"</span>:<span class="string">@"2"</span>&#125;.mutableCopy;</div><div class="line">    mDic[<span class="string">@"a"</span>]=<span class="string">@"100"</span>;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,mDic[<span class="string">@"a"</span>]);</div></pre></td></tr></table></figure>
<hr>
<blockquote>
<p>@()介绍以及使用</p>
</blockquote>
<p>在 Objective-C 中我们可以用 @”foo” 来创建一个 NSString 常量，看起来似乎平淡无奇。<br> 但它背后其实比想象的精彩，@ 可以被理解成一个特殊的宏，其接受一个 C 字符串作为参数，也可写作 @(“foo”)。<br> 之所以说 @ 是一个特殊的宏，是因为其能根据传入的 C 字符串类型不同——C 字符串常量或 C 字符串——在运行时构建返回不同类型的 NSString，<br>参见下面的代码：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">char</span>* obtain_c_string(<span class="keyword">void</span>)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">"c_string"</span>;</div><div class="line">&#125;</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, <span class="string">@"foo"</span>.class);</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, @(<span class="string">"bar"</span>).class);</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, @(obtain_c_string()).class);</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,<span class="string">@"aaa"</span>);</div><div class="line"><span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,@(<span class="string">"aaa"</span>));</div></pre></td></tr></table></figure></p>
<p>输出如下<br><code>__NSCFConstantString</code><br><code>__NSCFConstantString</code><br><code>__NSCFString</code><br><code>aaa</code><br><code>aaa</code></p>
<p>可见，如果传入的是 C 字符串常量，<code>运行时</code>构建的则为 <code>NSConstantString</code>；如果传入的是<code>C 字符串</code>则创建的是 <code>NSString</code>。<br>众所周知，Objective-C 代码里有很多地方需要我们把代码中的一些文法串写成字符串再作为传入参数，比如 KVO 中的 keyPath 参数往往就要传入形如 propertyA.propertyB 的字符串，从实用角度出发这有两个弊端： 写字符串的时候没有代码提示，很容易写错 即便一开始写对了，如果后来相关类重构了，keyPath 的参数便失效了，而 Xcode Refactor 无法扫描字符串 当我们理解了 @()，再加上自定义的宏，上述两个问题便可迎刃而解。<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * # 将宏的参数字符串化，C 函数 strchr 返回字符串中第一个 '.' 字符的位置</div><div class="line"> */</div><div class="line"><span class="selector-id">#define</span> <span class="selector-tag">Keypath</span>(keypath) (strchr(#keypath, <span class="string">'.'</span>) + <span class="number">1</span>)</div><div class="line"><span class="comment">// 有代码提示，可以被重构扫描到</span></div><div class="line"><span class="selector-attr">[objA addObserver: objB forKeyPath: @Keypath(ObjA.property1.property2) options: nil context: nil]</span>;</div></pre></td></tr></table></figure></p>
<hr>
<blockquote>
<p>UI使用部分</p>
</blockquote>
<p>拿UIImageView来做例子,原来创建对象和下面一致<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">self</span>.imageView = [[<span class="built_in">UIImageView</span> alloc] init];  </div><div class="line"><span class="keyword">self</span>.imageView.backgroundColor = [<span class="built_in">UIColor</span> redColor];  </div><div class="line"><span class="keyword">self</span>.imageView.image = [<span class="built_in">UIImage</span> imageNamed:<span class="string">@"12345"</span>];  </div><div class="line"><span class="keyword">self</span>.imageView.frame = <span class="built_in">CGRectMake</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">100</span>);  </div><div class="line">[<span class="keyword">self</span>.view addSubview:<span class="keyword">self</span>.imageView];</div></pre></td></tr></table></figure></p>
<h2 id="重点来了"><a href="#重点来了" class="headerlink" title="重点来了"></a><strong>重点来了</strong></h2><p>这个就是语法糖在UI中创建对象的使用,瞬间感觉很高大上~<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">self.imageView = (&#123;  </div><div class="line">    UIImageView *imageView = [[UIImageView alloc] init]<span class="comment">;  </span></div><div class="line">    imageView.<span class="keyword">backgroundColor </span>= [UIColor redColor]<span class="comment">;  </span></div><div class="line">    imageView.image = [UIImage imageNamed:@<span class="string">"12345"</span>]<span class="comment">;  </span></div><div class="line">    imageView.frame = CGRectMake(<span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">100</span>)<span class="comment">;  </span></div><div class="line">    [self.view <span class="keyword">addSubview:imageView]; </span> </div><div class="line">    imageView<span class="comment">;  </span></div><div class="line">&#125;)<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<h1 id="swift语法糖"><a href="#swift语法糖" class="headerlink" title="swift语法糖"></a>swift语法糖</h1><hr>
<h2 id="if-let-与-guard-语法糖"><a href="#if-let-与-guard-语法糖" class="headerlink" title="if let 与 guard 语法糖"></a>if let 与 guard 语法糖</h2><p>话说if let 和 guard 只是语法糖，没有也可以，但有了可以使得代码更简洁方便。要理解 if let 和 guard，不妨设想假如没有这两者，代码会怎么写。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> <span class="keyword">let</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doSomething</span><span class="params">(str: String?)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">let</span> v: <span class="type">String</span>! = str</div><div class="line">    <span class="keyword">if</span> v != <span class="literal">nil</span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">// use v to do something</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Swift 中因为有optional, 经常需要判断是否为空。假如没有if let，大致写成上面的样子，有了if let, 可以改写成<br> <figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doSomething</span><span class="params">(str: String?)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> <span class="keyword">let</span> v = str</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// use v to do something</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面两段代码的控制流是一样的。对照着，可以看出if let的写法更加简洁方便。<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">guard</span></div><div class="line">假如<span class="keyword">if</span>中出现的代码很长，我们写代码时可以将错误情况先返回。比如：</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doSomething</span><span class="params">(str: String?)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">let</span> v: <span class="type">String</span>! = str</div><div class="line">    <span class="keyword">if</span> v == <span class="literal">nil</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// use v to do something</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样做可以避免过多的嵌套。上面代码实在太常见了，swift也提供一个guard这个语法糖，用guard可以改写成：<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">doSomething</span><span class="params">(str: String?)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> v = str <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// use v to do something</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面两段代码的控制流是一样的。也可以看出guard的写法更加简洁方便。</p>
<p>至于if let 和 guard 语法中出现的where，只是附加一些条件。相当于逻辑运算 &amp;&amp; 和 ||。SQL中的条件语法也是用where这个关键字。</p>
<p>假如还不理解，动手将一段代码，不用if let 和 guard 进行改写。试多几次，就会发觉很自然了。</p>
<h2 id="语法糖Selector例子"><a href="#语法糖Selector例子" class="headerlink" title="语法糖Selector例子"></a>语法糖Selector例子</h2><p>创建控制器，添加Button<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">super</span>.viewDidLoad()</div><div class="line">    </div><div class="line">    <span class="keyword">let</span> btn = <span class="type">UIButton</span>(frame: <span class="type">CGRectMake</span>(<span class="number">100</span>,<span class="number">100</span>,<span class="number">100</span>,<span class="number">100</span>))</div><div class="line">    btn.backgroundColor = <span class="type">UIColor</span>.redColor()</div><div class="line">    view.addSubview(btn)</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">printFire</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="built_in">print</span>(<span class="string">"fire"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>想实现控制器里的Button点击事件，但是，如果一个控制器里的Button特别的多，那添加Button点击事件的Selector 会觉得特别的臃肿。所以语法糖就是要拓展Selector<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">extension</span> <span class="title">Selector</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">let</span> printFire = #selector(<span class="type">ViewController</span>.printFire)</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们现在给viewDidLoad方法中的Button 添加点击事件<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">btn</span><span class="selector-class">.addTarget</span>(<span class="selector-tag">self</span>, <span class="selector-tag">action</span>: <span class="selector-class">.printFire</span>, <span class="selector-tag">forControlEvents</span>: <span class="selector-class">.TouchUpInside</span>)</div></pre></td></tr></table></figure></p>
<p>如果Button过多的话，用语法糖方便管理Button的点击事件，又不会把点击事件变得过于臃肿</p>
<p>下面是控制器的完整代码<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> UIKit</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewController</span>: <span class="title">UIViewController</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">super</span>.viewDidLoad()</div><div class="line">        </div><div class="line">        <span class="keyword">let</span> btn = <span class="type">UIButton</span>(frame: <span class="type">CGRectMake</span>(<span class="number">100</span>,<span class="number">100</span>,<span class="number">100</span>,<span class="number">100</span>))</div><div class="line">        btn.backgroundColor = <span class="type">UIColor</span>.redColor()</div><div class="line">        btn.addTarget(<span class="keyword">self</span>, action: .printFire, forControlEvents: .<span class="type">TouchUpInside</span>)</div><div class="line">        view.addSubview(btn)</div><div class="line">        </div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">func</span> <span class="title">printFire</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="built_in">print</span>(<span class="string">"fire"</span>)</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">didReceiveMemoryWarning</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">super</span>.didReceiveMemoryWarning()</div><div class="line">        <span class="comment">// Dispose of any resources that can be recreated.</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">extension</span> <span class="title">Selector</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">static</span> <span class="keyword">let</span> printFire = #selector(<span class="type">ViewController</span>.printFire)</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>作者信息</p>
</blockquote>
<p>如果有不足或者错误的地方还望各位读者批评指正，可以评论留言，笔者收到后第一时间回复。</p>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">具体信息</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">QQ/微信</td>
<td style="text-align:center">hundreda</td>
</tr>
<tr>
<td style="text-align:center">简书号连接</td>
<td style="text-align:center"><a href="http://www.jianshu.com/users/a3ae6d7c68b6/latest_articles" target="_blank" rel="external">iOS-香蕉大大</a></td>
</tr>
<tr>
<td style="text-align:center">GitHub个人开源主页</td>
<td style="text-align:center"><a href="https://github.com/OneHundredSir" target="_blank" rel="external">GitHub连接</a></td>
</tr>
<tr>
<td style="text-align:center">好心人赏我个<code>赞</code></td>
<td style="text-align:center"><code>欢迎各位前来查看，star,感谢各位的阅读</code></td>
</tr>
<tr>
<td style="text-align:center">个人iOS开发QQ讨论群</td>
<td style="text-align:center"><strong>365204530</strong></td>
</tr>
<tr>
<td style="text-align:center"><code>群内规矩</code></td>
<td style="text-align:center"><code>聊天扯淡，讨论技术都行，没有什么群规，不懂就问</code></td>
</tr>
<tr>
<td style="text-align:center">iOS开发类微信订阅号</td>
<td style="text-align:center"><strong>大大家的IOS说</strong></td>
</tr>
<tr>
<td style="text-align:center"><em>微信扫一扫下面二维码</em></td>
<td style="text-align:center"><code>一起用碎片时间学习IOS吧</code></td>
</tr>
</tbody>
</table>
<p><img src="http://upload-images.jianshu.io/upload_images/1730495-755d908f00d77cf8.gif?imageMogr2/auto-orient/strip" alt="微信个人技术订阅号"><br>喜欢的朋友可以赏我2块大洋买糖吃～你的打赏是我前进的动力~一起做一个乐于分享的人吧~</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/iOS进阶/">iOS进阶</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/iOS黑魔法/">iOS黑魔法</a><a href="/tags/iOS进阶拓展/">iOS进阶拓展</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/20/IOS黑魔法/IOS开发---黑魔法之blocksKit分析(上)/" title="iOS开发---黑魔法之blocksKit分析(上)" itemprop="url">iOS开发---黑魔法之blocksKit分析(上)</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Hundred Wang" target="_blank" itemprop="author">Hundred Wang</a>
		
  <p class="article-time">
    <time datetime="2016-06-19T22:49:50.000Z" itemprop="datePublished"> 发表于 2016-06-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><ul>
<li>上篇链接:<a href="http://www.jianshu.com/p/1f6669ee0ddb" target="_blank" rel="external">IOS开发 - 黑魔法之blocksKit分析(上)</a></li>
<li>下篇链接:<a href="http://www.jianshu.com/p/59d2e8a77e05" target="_blank" rel="external">IOS开发 - 黑魔法之blocksKit分析(下)</a></li>
<li>应用篇含演示demo:<a href="http://www.jianshu.com/p/e9ff8c62781a" target="_blank" rel="external">IOS开发 - 黑魔法之blocksKit应用篇</a></li>
</ul>
<p>BlocksKit项目主页:<a href="https://github.com/zwaldowski/BlocksKit" target="_blank" rel="external">BlocksKit-github主页</a></p>
<hr>
<h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h1><p>本篇文章只适合对delegate和block进阶使用,不适合对以上两个概念的初学者学习.<br>高能预警：本篇文章非常长，因为 BlocksKit 的实现还是比较复杂和有意的。这篇文章不是为了剖析 iOS 开发中的 block 的实现以及它是如何组成甚至使用的，如果你想通过这篇文章来了解 block 的实现，它并不能帮到你。</p>
<p>Block 到底是什么？这可能是困扰很多 iOS 初学者的一个问题。如果你在 Google 上搜索类似的问题时，可以查找到几十万条结果，block 在 iOS 开发中有着非常重要的地位，而且它的作用也越来越重要。</p>
<hr>
<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>这篇文章仅对 BlocksKit v2.2.5 的源代码进行分析，从框架的内部理解下面的功能是如何实现的：</p>
<p>为 NSArray、 NSDictionary 和 NSSet 等集合类型以及对应的可变集合类型 NSMutableArray、NSMutableDictionary 和 NSMutableSet 添加 bk_each: 等方法完成对集合中元素的快速遍历<br>使用 block 对 NSObject 对象 KVO<br>为 UIView 对象添加 bk_whenTapped: 等方法快速添加手势<br>使用 block 替换 UIKit 中的 delegate ，涉及到核心模块 DynamicDelegate。</p>
<p>BlocksKit 框架中包括但不仅限于上述的功能，这篇文章是对 v2.2.5 版本源代码的分析，其它版本的功能不会在本篇文章中具体讨论。</p>
<p>如何提供简洁的遍历方法</p>
<p>BlocksKit 实现的最简单的功能就是为集合类型添加方法遍历集合中的元素。<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[@[@<span class="number">1</span>,@<span class="number">2</span>,@<span class="number">3</span>] bk_each:^(<span class="name">id</span> obj) &#123;</div><div class="line">    NSLog(@<span class="string">"%@"</span>，obj)<span class="comment">;</span></div><div class="line">&#125;]<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>这段代码非常简单，我们可以使用 enumerateObjectsUsingBlock: 方法替代 bk_each: 方法：<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[@[@<span class="number">1</span>,@<span class="number">2</span>,@<span class="number">3</span>] enumerateObjectsUsingBlock:^(<span class="name">id</span> obj，NSUInteger idx，BOOL *stop) &#123;</div><div class="line">    NSLog(@<span class="string">"%@"</span>，obj)<span class="comment">;</span></div><div class="line">&#125;]<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>结果<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">2016<span class="selector-tag">-03-05</span> 16<span class="selector-pseudo">:02</span><span class="selector-pseudo">:57.295</span> <span class="selector-tag">Draveness</span><span class="selector-attr">[10725:453402]</span> 1</div><div class="line">2016<span class="selector-tag">-03-05</span> 16<span class="selector-pseudo">:02</span><span class="selector-pseudo">:57.296</span> <span class="selector-tag">Draveness</span><span class="selector-attr">[10725:453402]</span> 2</div><div class="line">2016<span class="selector-tag">-03-05</span> 16<span class="selector-pseudo">:02</span><span class="selector-pseudo">:57.297</span> <span class="selector-tag">Draveness</span><span class="selector-attr">[10725:453402]</span> 3</div></pre></td></tr></table></figure></p>
<p>这部分代码的实现也没什么难度：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)bk_each:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> obj))block</div><div class="line">&#123;</div><div class="line">    <span class="built_in">NSParameterAssert</span>(block != <span class="literal">nil</span>);</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span> enumerateObjectsUsingBlock:^(<span class="keyword">id</span> obj，<span class="built_in">NSUInteger</span> idx，<span class="built_in">BOOL</span> *stop) &#123;</div><div class="line">        block(obj);</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>它在 block 执行前会判断传进来的 block 是否为空，然后就是调用遍历方法，把数组中的每一个 obj 传给 block。</p>
<p>BlocksKit 在这些集合类中所添加的一些方法在 Ruby、Haskell 等语言中也同样存在。如果你接触过上面的语言，理解这里方法的功能也就更容易了，不过这不是这篇文章关注的主要内容。<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// NSArray+BlocksKit.h</span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)bk_each:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> obj))block;</div><div class="line">- (<span class="keyword">void</span>)bk_apply:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> obj))block;</div><div class="line">- (<span class="keyword">id</span>)bk_match:(<span class="built_in">BOOL</span> (^)(<span class="keyword">id</span> obj))block;</div><div class="line">- (<span class="built_in">NSArray</span> *)bk_select:(<span class="built_in">BOOL</span> (^)(<span class="keyword">id</span> obj))block;</div><div class="line">- (<span class="built_in">NSArray</span> *)bk_reject:(<span class="built_in">BOOL</span> (^)(<span class="keyword">id</span> obj))block;</div><div class="line">- (<span class="built_in">NSArray</span> *)bk_map:(<span class="keyword">id</span> (^)(<span class="keyword">id</span> obj))block;</div><div class="line">- (<span class="keyword">id</span>)bk_reduce:(<span class="keyword">id</span>)initial withBlock:(<span class="keyword">id</span> (^)(<span class="keyword">id</span> sum，<span class="keyword">id</span> obj))block;</div><div class="line">- (<span class="built_in">NSInteger</span>)bk_reduceInteger:(<span class="built_in">NSInteger</span>)initial withBlock:(<span class="built_in">NSInteger</span>(^)(<span class="built_in">NSInteger</span> result，<span class="keyword">id</span> obj))block;</div><div class="line">- (<span class="built_in">CGFloat</span>)bk_reduceFloat:(<span class="built_in">CGFloat</span>)inital withBlock:(<span class="built_in">CGFloat</span>(^)(<span class="built_in">CGFloat</span> result，<span class="keyword">id</span> obj))block;</div><div class="line">- (<span class="built_in">BOOL</span>)bk_any:(<span class="built_in">BOOL</span> (^)(<span class="keyword">id</span> obj))block;</div><div class="line">- (<span class="built_in">BOOL</span>)bk_none:(<span class="built_in">BOOL</span> (^)(<span class="keyword">id</span> obj))block;</div><div class="line">- (<span class="built_in">BOOL</span>)bk_all:(<span class="built_in">BOOL</span> (^)(<span class="keyword">id</span> obj))block;</div><div class="line">- (<span class="built_in">BOOL</span>)bk_corresponds:(<span class="built_in">NSArray</span> *)list withBlock:(<span class="built_in">BOOL</span> (^)(<span class="keyword">id</span> obj1，<span class="keyword">id</span> obj2))block;</div></pre></td></tr></table></figure></p>
<hr>
<p><strong>NSObject 上的魔法</strong></p>
<p>NSObject 是 iOS 中的『上帝类』。</p>
<p>在 NSObject 上添加的方法几乎会添加到 Cocoa Touch 中的所有类上，关于 NSObject 的讨论和总共分为以下三部分进行：</p>
<p>1.AssociatedObject<br>2.BlockExecution<br>3.BlockObservation</p>
<p>添加 AssociatedObject</p>
<p>经常跟 runtime 打交道的人不可能不知道 AssociatedObject ，当我们想要为一个已经存在的类添加属性时，就需要用到 AssociatedObject 为类添加属性，而 BlocksKit 提供了更简单的方法来实现，不需要新建一个分类。<br><figure class="highlight prolog"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">NSObject</span> *test = [[<span class="symbol">NSObject</span> alloc] init];</div><div class="line">[test bk_associateValue:@<span class="string">"Draveness"</span> withKey:@<span class="string">" name"</span>];</div><div class="line"><span class="symbol">NSLog</span>(@<span class="string">"%@"</span>，[test bk_associatedValueForKey:@<span class="string">"name"</span>]);</div></pre></td></tr></table></figure></p>
<p>输出结果:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">2016<span class="selector-tag">-03-05</span> 16<span class="selector-pseudo">:02</span><span class="selector-pseudo">:25.761</span> <span class="selector-tag">Draveness</span><span class="selector-attr">[10699:452125]</span> <span class="selector-tag">Draveness</span></div></pre></td></tr></table></figure>
<p>这里我们使用了 <code>bk_associateValue:withKey:</code>和 <code>bk_associatedValueForKey:</code>两个方法设置和获取 name 对应的值Draveness.</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)bk_associateValue:(id)<span class="keyword">value</span> withKey:(<span class="keyword">const</span> <span class="keyword">void</span> *)key</div><div class="line">&#123;</div><div class="line">    objc_setAssociatedObject(self，key，<span class="keyword">value</span>，OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的 OBJC_ASSOCIATION_RETAIN_NONATOMIC 表示当前属性为 retain nonatomic 的，还有其它的参数如下：</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Policies related to associative references.</div><div class="line"> * These are options to objc_setAssociatedObject()</div><div class="line"> */</div><div class="line">typedef OBJC_ENUM(uintptr_t，objc_AssociationPolicy) &#123;</div><div class="line">    OBJC_ASSOCIATION_ASSIGN = <span class="number">0</span>，          <span class="comment">/**&lt; Specifies a weak reference to the associated object. */</span></div><div class="line">    OBJC_ASSOCIATION_RETAIN_NONATOMIC = <span class="number">1</span>，<span class="comment">/**&lt; Specifies a strong reference to the associated object.</span></div><div class="line">                                           *   The association is not made atomically. */</div><div class="line">    OBJC_ASSOCIATION_COPY_NONATOMIC = <span class="number">3</span>，  <span class="comment">/**&lt; Specifies that the associated object is copied.</span></div><div class="line">                                           *   The association is not made atomically. */</div><div class="line">    OBJC_ASSOCIATION_RETAIN = <span class="number">01401</span>，      <span class="comment">/**&lt; Specifies a strong reference to the associated object.</span></div><div class="line">                                           *   The association is made atomically. */</div><div class="line">    OBJC_ASSOCIATION_COPY = <span class="number">01403</span>          <span class="comment">/**&lt; Specifies that the associated object is copied.</span></div><div class="line">                                            *   The association is made atomically. */</div><div class="line">    &#125;;</div></pre></td></tr></table></figure>
<p>上面的这个 NS_ENUM 也没什么好说的，需要注意的是这里没有 weak 属性。</p>
<p>BlocksKit 通过另一种方式实现了『弱属性』：</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (void)bk_weaklyAssociateValue:(__autoreleasing id)value withKey:(const void *)<span class="built_in">key</span></div><div class="line">    &#123;</div><div class="line">        _BKWeakAssociatedObject *<span class="built_in">assoc</span> = objc_getAssociatedObject(self，<span class="built_in">key</span>);</div><div class="line">        <span class="keyword">if</span> (!<span class="built_in">assoc</span>) &#123;</div><div class="line">            <span class="built_in">assoc</span> = [_BKWeakAssociatedObject <span class="built_in">new</span>];</div><div class="line">            [self bk_associateValue:<span class="built_in">assoc</span> withKey:<span class="built_in">key</span>];</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">assoc</span>.value = value;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这里先获取了一个 _BKWeakAssociatedObject 对象 assoc，然后更新这个对象的属性 value。</p>
<p>因为直接使用 AssociatedObject 不能为对象添加弱属性，所以在这里添加了一个对象，然后让这个对象持有一个弱属性：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> <span class="attribute">_BKWeakAssociatedObject </span>: NSObject</div><div class="line"></div><div class="line"><span class="variable">@property</span> (nonatomic，weak) id value;</div><div class="line"></div><div class="line"><span class="variable">@end</span></div><div class="line">    </div><div class="line"><span class="variable">@implementation</span> _BKWeakAssociatedObject</div><div class="line"></div><div class="line"><span class="variable">@end</span></div></pre></td></tr></table></figure>
<p>这就是 BlocksKit 实现弱属性的方法，我觉得这个实现的方法还是比较简洁的。</p>
<p>getter 方法的实现也非常类似：</p>
<pre><code>- (id)bk_associatedValueForKey:(const void *)key
{
    id value = objc_getAssociatedObject(self，key);
    if (value &amp;&amp; [value isKindOfClass:[_BKWeakAssociatedObject class]]) {
        return [(_BKWeakAssociatedObject *)value value];
    }
    return value;
}
</code></pre><hr>
<p> <strong>在任意对象上执行 block</strong></p>
<p>通过这个类提供的一些接口，可以在任意对象上快速执行线程安全、异步的 block，而且这些 block 也可以在执行之前取消。</p>
<pre><code>- (id &lt;NSObject，NSCopying&gt;)bk_performOnQueue:(dispatch_queue_t)queue afterDelay:(NSTimeInterval)delay usingBlock:(void (^)(id obj))block
{
    NSParameterAssert(block != nil);

    return BKDispatchCancellableBlock(queue，delay，^{
        block(self);
    });
}
</code></pre><p>判断 block 是否为空在这里都是细枝末节，这个方法中最关键的也就是它返回了一个可以取消的 block，而这个 block 就是用静态函数 BKDispatchCancellableBlock 生成的。</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">static id &lt;NSObject，NSCopying&gt; <span class="keyword">BKDispatchCancellableBlock(dispatch_queue_t </span>queue，NSTimeInterval delay，void(^<span class="keyword">block)(void)) </span>&#123;</div><div class="line">        <span class="keyword">dispatch_time_t </span>time = <span class="keyword">BKTimeDelay(delay);</span></div><div class="line">        </div><div class="line"><span class="comment">#if DISPATCH_CANCELLATION_SUPPORTED</span></div><div class="line">        if (<span class="keyword">BKSupportsDispatchCancellation()) </span>&#123;</div><div class="line">            <span class="keyword">dispatch_block_t </span>ret = <span class="keyword">dispatch_block_create(0，block);</span></div><div class="line">            <span class="keyword">dispatch_after(time，queue，ret);</span></div><div class="line">            return ret<span class="comment">;</span></div><div class="line">        &#125;</div><div class="line"><span class="comment">#endif</span></div><div class="line">        </div><div class="line">        __block <span class="keyword">BOOL </span>cancelled = NO<span class="comment">;</span></div><div class="line">        void (^wrapper)(<span class="keyword">BOOL) </span>= ^(<span class="keyword">BOOL </span>cancel) &#123;</div><div class="line">            if (cancel) &#123;</div><div class="line">                cancelled = YES<span class="comment">;</span></div><div class="line">                return<span class="comment">;</span></div><div class="line">            &#125;</div><div class="line">            if (!cancelled) <span class="keyword">block();</span></div><div class="line">        &#125;<span class="comment">;</span></div><div class="line">        </div><div class="line">        <span class="keyword">dispatch_after(time，queue，^&#123;</span></div><div class="line">            wrapper(NO)<span class="comment">;</span></div><div class="line">        &#125;)<span class="comment">;</span></div><div class="line">        </div><div class="line">        return wrapper<span class="comment">;</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这个函数首先会执行 BKSupportsDispatchCancellation 来判断当前平台和版本是否支持使用 GCD 取消 block，当然一般都是支持的：</p>
<ul>
<li>函数返回的是 YES，那么在 block 被派发到指定队列之后就会返回这个 dispatch_block_t 类型的 block</li>
<li>函数返回的是 NO，那么就会就会手动包装一个可以取消的 block，具体实现的部分如下：</li>
</ul>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">    __block <span class="keyword">BOOL </span>cancelled = NO<span class="comment">;</span></div><div class="line">    void (^wrapper)(<span class="keyword">BOOL) </span>= ^(<span class="keyword">BOOL </span>cancel) &#123;</div><div class="line">        if (cancel) &#123;</div><div class="line">            cancelled = YES<span class="comment">;</span></div><div class="line">            return<span class="comment">;</span></div><div class="line">        &#125;</div><div class="line">        if (!cancelled) <span class="keyword">block();</span></div><div class="line">    &#125;<span class="comment">;</span></div><div class="line">    </div><div class="line">    <span class="keyword">dispatch_after(time，queue，^&#123;</span></div><div class="line">        wrapper(NO)<span class="comment">;</span></div><div class="line">    &#125;)<span class="comment">;</span></div><div class="line">    </div><div class="line">    return wrapper<span class="comment">;</span></div></pre></td></tr></table></figure>
<p>上面这部分代码就先创建一个 wrapper block，然后派发到指定队列，派发到指定队列的这个 block 是一定会执行的，但是怎么取消这个 block 呢？</p>
<p>如果当前 block 没有执行，我们在外面调用一次 wrapper(YES) 时，block 内部的 cancelled 变量就会被设置为 YES，所以 block 就不会执行。</p>
<p>1.dispatch_after — cancelled = NO<br>2.wrapper(YES) — cancelled = YES<br>3.wrapper(NO) — cancelled = YES block 不会执行</p>
<p>这是实现取消的关键部分：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">+ (<span class="keyword">void</span>)bk_cancelBlock:(<span class="keyword">id</span> &lt;<span class="built_in">NSObject</span>，<span class="built_in">NSCopying</span>&gt;)block</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">NSParameterAssert</span>(block != <span class="literal">nil</span>);</div><div class="line">        </div><div class="line"><span class="meta">#if DISPATCH_CANCELLATION_SUPPORTED</span></div><div class="line">        <span class="keyword">if</span> (BKSupportsDispatchCancellation()) &#123;</div><div class="line">            dispatch_block_cancel((dispatch_block_t)block);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"><span class="meta">#endif</span></div><div class="line">        </div><div class="line">        <span class="keyword">void</span> (^wrapper)(<span class="built_in">BOOL</span>) = (<span class="keyword">void</span>(^)(<span class="built_in">BOOL</span>))block;</div><div class="line">        wrapper(<span class="literal">YES</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>GCD 支持取消 block，那么直接调用 dispatch_block_cancel 函数取消 block<br>GCD 不支持取消 block 那么调用一次 wrapper(YES)</p>
<hr>
<h1 id="使用-Block-封装-KVO"><a href="#使用-Block-封装-KVO" class="headerlink" title="使用 Block 封装 KVO"></a><strong>使用 Block 封装 KVO</strong></h1><p>BlocksKit 对 KVO 的封装由两部分组成：</p>
<ol>
<li>NSObject 的分类负责提供便利方法</li>
<li>私有类 _BKObserver 具体实现原生的 KVO 功能</li>
</ol>
<hr>
<h1 id="提供接口并在-dealloc-时停止-BlockObservation"><a href="#提供接口并在-dealloc-时停止-BlockObservation" class="headerlink" title="提供接口并在 dealloc 时停止 BlockObservation"></a><strong>提供接口并在 dealloc 时停止 BlockObservation</strong></h1><p>NSObject+BKBlockObservation 这个分类中的大部分接口都会调用这个方法:<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">    - (void)<span class="keyword">bk_addObserverForKeyPaths:(NSArray </span>*)keyPaths identifier:(NSString *)identifier options:(NSKeyValueObservingOptions)options <span class="built_in">context</span>:(<span class="keyword">BKObserverContext)context </span>task:(id)task</div><div class="line">    &#123;</div><div class="line"><span class="comment">#1: 检查参数，省略</span></div><div class="line">        </div><div class="line"><span class="comment">#2: 使用神奇的方法在分类中覆写 dealloc</span></div><div class="line">        </div><div class="line">        NSMutableDictionary *<span class="keyword">dict;</span></div><div class="line">        _BKObserver *observer = [[_BKObserver alloc] initWithObservee:self keyPaths:keyPaths <span class="built_in">context</span>:<span class="built_in">context</span> task:task]<span class="comment">;</span></div><div class="line">        [observer startObservingWithOptions:options]<span class="comment">;</span></div><div class="line">        </div><div class="line"><span class="comment">#3: 惰性初始化 bk_observerBlocks 也就是下面的 dict，省略</span></div><div class="line">        </div><div class="line">        <span class="keyword">dict[identifier] </span>= observer<span class="comment">;</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>我们不会在这里讨论 #1、#3 部分，再详细阅读 #2 部分代码之前，先来看一下这个省略了绝大部分细节的核心方法。</p>
<p>使用传入方法的参数创建了一个 _BKObserver 对象，然后调用 <code>startObservingWithOptions:</code>方法开始 KVO 观测相应的属性，然后以 <code>{identifier，obeserver}</code> 的形式存到字典中保存。</p>
<p>这里实在没什么新意，我们在下一小节中会介绍 startObservingWithOptions: 这一方法。</p>
<p>在分类中调剂 dealloc 方法</p>
<p>这个问题我觉得是非常值得讨论的一个问题，也是我最近在写框架时遇到很棘手的一个问题。</p>
<p>当我们在分类中注册一些通知或者使用 KVO 时，很有可能会找不到注销这些通知的时机。</p>
<p>因为在分类中是无法直接实现 dealloc 方法的。 在 iOS8 以及之前的版本，如果某个对象被释放了，但是刚对象的注册的通知没有被移除，那么当事件再次发生，就会向已经释放的对象发出通知，整个程序就会崩溃。</p>
<p>这里解决的办法就十分的巧妙:</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">    Class classToSwizzle = <span class="keyword">self</span>.class;</div><div class="line">    <span class="comment">// 获取所有修改过 dealloc 方法的类</span></div><div class="line">    <span class="built_in">NSMutableSet</span> *classes = <span class="keyword">self</span>.class.bk_observedClassesHash;</div><div class="line">    </div><div class="line">    <span class="comment">// 保证互斥避免 classes 出现难以预测的结果</span></div><div class="line">    <span class="keyword">@synchronized</span> (classes) &#123;</div><div class="line">        </div><div class="line">        <span class="comment">// 获取当前类名，并判断是否修改过 dealloc 方法以减少这部分代码的调用次数</span></div><div class="line">        <span class="built_in">NSString</span> *className = <span class="built_in">NSStringFromClass</span>(classToSwizzle);</div><div class="line">        <span class="keyword">if</span> (![classes containsObject:className]) &#123;</div><div class="line">            <span class="comment">// 这里的 sel_registerName 方法会返回 dealloc 的 selector，因为 dealloc 已经注册过</span></div><div class="line">            SEL deallocSelector = sel_registerName(<span class="string">"dealloc"</span>);</div><div class="line">            </div><div class="line">            __block <span class="keyword">void</span> (*originalDealloc)(__<span class="keyword">unsafe_unretained</span> <span class="keyword">id</span>，SEL) = <span class="literal">NULL</span>;</div><div class="line">            </div><div class="line">            <span class="comment">// 实现新的 dealloc 方法</span></div><div class="line">            <span class="keyword">id</span> newDealloc = ^(__<span class="keyword">unsafe_unretained</span> <span class="keyword">id</span> objSelf) &#123;</div><div class="line">                <span class="comment">//在方法 dealloc 之前移除所有 observer</span></div><div class="line">                [objSelf bk_removeAllBlockObservers];</div><div class="line">                </div><div class="line">                <span class="keyword">if</span> (originalDealloc == <span class="literal">NULL</span>) &#123;</div><div class="line">                    <span class="comment">// 如果原有的 dealloc 方法没有被找到就会查找父类的 dealloc 方法，调用父类的 dealloc 方法</span></div><div class="line">                    <span class="keyword">struct</span> objc_super superInfo = &#123;</div><div class="line">                        .receiver = objSelf,</div><div class="line">                        .super_class = class_getSuperclass(classToSwizzle)</div><div class="line">                    &#125;;</div><div class="line">                    </div><div class="line">                    <span class="keyword">void</span> (*msgSend)(<span class="keyword">struct</span> objc_super *，SEL) = (__typeof__(msgSend))objc_msgSendSuper;</div><div class="line">                    msgSend(&amp;superInfo，deallocSelector);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// 如果 dealloc 方法被找到就会直接调用该方法，并传入参数</span></div><div class="line">                    originalDealloc(objSelf，deallocSelector);</div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line">            </div><div class="line">            <span class="comment">// 构建选择子实现 IMP</span></div><div class="line">            IMP newDeallocIMP = imp_implementationWithBlock(newDealloc);</div><div class="line">            </div><div class="line">            <span class="comment">// 向当前类添加方法，但是多半不会成功，因为类已经有 dealloc 方法</span></div><div class="line">            <span class="keyword">if</span> (!class_addMethod(classToSwizzle，deallocSelector，newDeallocIMP，<span class="string">"v@:"</span>)) &#123;</div><div class="line">                <span class="comment">// 获取原有 dealloc 实例方法</span></div><div class="line">                Method deallocMethod = class_getInstanceMethod(classToSwizzle，deallocSelector);</div><div class="line">                </div><div class="line">                <span class="comment">// 存储 dealloc 方法实现防止在 set 的过程中调用该方法</span></div><div class="line">                originalDealloc = (<span class="keyword">void</span>(*)(__<span class="keyword">unsafe_unretained</span> <span class="keyword">id</span>，SEL))method_getImplementation(deallocMethod);</div><div class="line">                </div><div class="line">                <span class="comment">// 重新设置 dealloc 方法的实现，并存储到 originalDealloc 防止方法实现改变</span></div><div class="line">                originalDealloc = (<span class="keyword">void</span>(*)(__<span class="keyword">unsafe_unretained</span> <span class="keyword">id</span>，SEL))method_setImplementation(deallocMethod，newDeallocIMP);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">// 将当前类名添加到已经改变的类的集合中</span></div><div class="line">            [classes addObject:className];</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>这部分代码的执行顺序如下:</p>
<h2 id="1-首先调用-bk-observedClassesHash-类方法获取所有修改过-dealloc-方法的类的集合-classes"><a href="#1-首先调用-bk-observedClassesHash-类方法获取所有修改过-dealloc-方法的类的集合-classes" class="headerlink" title="1. 首先调用 bk_observedClassesHash 类方法获取所有修改过 dealloc 方法的类的集合 classes"></a>1. 首先调用 bk_observedClassesHash 类方法获取所有修改过 dealloc 方法的类的集合 classes</h2><h2 id="2-使用-synchronized-classes-保证互斥，避免同时修改-classes-集合的类过多出现意料之外的结果"><a href="#2-使用-synchronized-classes-保证互斥，避免同时修改-classes-集合的类过多出现意料之外的结果" class="headerlink" title="2. 使用 @synchronized (classes) 保证互斥，避免同时修改 classes 集合的类过多出现意料之外的结果"></a>2. 使用 @synchronized (classes) 保证互斥，避免同时修改 classes 集合的类过多出现意料之外的结果</h2><h2 id="3-判断即将调剂方法的类-classToSwizzle-是否调剂过-dealloc-方法"><a href="#3-判断即将调剂方法的类-classToSwizzle-是否调剂过-dealloc-方法" class="headerlink" title="3. 判断即将调剂方法的类 classToSwizzle 是否调剂过 dealloc 方法"></a>3. 判断即将调剂方法的类 classToSwizzle 是否调剂过 dealloc 方法</h2><h2 id="4-如果-dealloc-方法没有调剂过，就会通过-sel-registerName-“dealloc”-方法获取选择子，这行代码并不会真正注册dealloc-选择子而是会获取-dealloc-的选择子，具体原因可以看这个方法的实现-sel-registerName"><a href="#4-如果-dealloc-方法没有调剂过，就会通过-sel-registerName-“dealloc”-方法获取选择子，这行代码并不会真正注册dealloc-选择子而是会获取-dealloc-的选择子，具体原因可以看这个方法的实现-sel-registerName" class="headerlink" title="4. 如果 dealloc 方法没有调剂过，就会通过 sel_registerName(“dealloc”)方法获取选择子，这行代码并不会真正注册dealloc 选择子而是会获取 dealloc 的选择子，具体原因可以看这个方法的实现 sel_registerName"></a>4. 如果 dealloc 方法没有调剂过，就会通过 <code>sel_registerName(“dealloc”)</code>方法获取选择子，这行代码并不会真正注册dealloc 选择子而是会获取 dealloc 的选择子，具体原因可以看这个方法的实现 <code>sel_registerName</code></h2><h2 id="5-在新的-dealloc-中添加移除-Observer-的方法，-再调用原有的-dealloc"><a href="#5-在新的-dealloc-中添加移除-Observer-的方法，-再调用原有的-dealloc" class="headerlink" title="5. 在新的 dealloc 中添加移除 Observer 的方法， 再调用原有的 dealloc"></a>5. 在新的 dealloc 中添加移除 Observer 的方法， 再调用原有的 dealloc</h2><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">    id newDealloc = ^(__unsafe_unretained id objSelf) &#123;</div><div class="line">        [objSelf <span class="keyword">bk_removeAllBlockObservers];</span></div><div class="line">        </div><div class="line">        if (<span class="keyword">originalDealloc </span>== NULL) &#123;</div><div class="line">            struct objc_super superInfo = &#123;</div><div class="line">                .receiver = objSelf,</div><div class="line">                .super_class = class_getSuperclass(classToSwizzle)</div><div class="line">            &#125;<span class="comment">;</span></div><div class="line">            void (*msgSend)(struct objc_super *，SEL) = (__typeof__(msgSend))objc_msgSendSuper<span class="comment">;</span></div><div class="line">            msgSend(&amp;superInfo，deallocSelector)<span class="comment">;</span></div><div class="line">        &#125; else &#123;</div><div class="line">            <span class="keyword">originalDealloc(objSelf，deallocSelector);</span></div><div class="line">        &#125;</div><div class="line">    &#125;<span class="comment">;</span></div><div class="line">    IMP newDeallocIMP = imp_implementationWithBlock(newDealloc)<span class="comment">;</span></div><div class="line">```  </div><div class="line">  *<span class="number">1</span>. 调用 `<span class="keyword">bk_removeAllBlockObservers` </span>方法移除所有观察者，也就是这段代码的最终目的*</div><div class="line">  *<span class="number">2</span>. 根据 <span class="keyword">originalDealloc </span>是否为空，决定是向父类发送消息，还是直接调用 <span class="keyword">originalDealloc </span>并传入 objSelf，deallocSelector 作为参数*</div><div class="line">    </div><div class="line"><span class="comment">## 6.在我们获得了新 dealloc 方法的选择子和 IMP 时，就要改变原有的 dealloc的实现了</span></div></pre></td></tr></table></figure>
<pre><code>if (!class_addMethod(classToSwizzle，deallocSelector，newDeallocIMP，&quot;v@:&quot;)) {
    // The class already contains a method implementation.
    Method deallocMethod = class_getInstanceMethod(classToSwizzle，deallocSelector);

    // We need to store original implementation before setting new implementation
    // in case method is called at the time of setting.
    originalDealloc = (void(*)(__unsafe_unretained id，SEL))method_getImplementation(deallocMethod);

    // We need to store original implementation again，in case it just changed.
    originalDealloc = (void(*)(__unsafe_unretained id，SEL))method_setImplementation(deallocMethod，newDeallocIMP);
}
</code></pre><p>```</p>
<h3 id="1-调用-class-addMethod-方法为当前类添加选择子为-dealloc-的方法（当然-99-99-的可能不会成功）"><a href="#1-调用-class-addMethod-方法为当前类添加选择子为-dealloc-的方法（当然-99-99-的可能不会成功）" class="headerlink" title="1.  调用 class_addMethod 方法为当前类添加选择子为 dealloc 的方法（当然 99.99% 的可能不会成功）"></a>1.  调用 class_addMethod 方法为当前类添加选择子为 dealloc 的方法（当然 99.99% 的可能不会成功）</h3><h3 id="2-获取原有的-dealloc-实例方法"><a href="#2-获取原有的-dealloc-实例方法" class="headerlink" title="2. 获取原有的 dealloc 实例方法"></a>2. 获取原有的 dealloc 实例方法</h3><h3 id="3-将原有的实现保存到-originalDealloc-中，防止使用-method-setImplementation-重新设置该方法的过程中调用dealloc-导致无方法可用"><a href="#3-将原有的实现保存到-originalDealloc-中，防止使用-method-setImplementation-重新设置该方法的过程中调用dealloc-导致无方法可用" class="headerlink" title="3.  将原有的实现保存到 originalDealloc 中，防止使用 method_setImplementation 重新设置该方法的过程中调用dealloc 导致无方法可用"></a>3.  将原有的实现保存到 originalDealloc 中，防止使用 method_setImplementation 重新设置该方法的过程中调用dealloc 导致无方法可用</h3><h3 id="4-重新设置-dealloc-方法的实现。同样，将实现存储到-originalDealloc-中防止实现改变"><a href="#4-重新设置-dealloc-方法的实现。同样，将实现存储到-originalDealloc-中防止实现改变" class="headerlink" title="4. 重新设置 dealloc 方法的实现。同样，将实现存储到 originalDealloc 中防止实现改变"></a>4. 重新设置 dealloc 方法的实现。同样，将实现存储到 originalDealloc 中防止实现改变</h3><p>关于在分类中调剂 dealloc 方法的这部分到这里就结束了，下一节将继续分析私有类 _BKObserver。</p>
<hr>
<h1 id="作者信息"><a href="#作者信息" class="headerlink" title="作者信息"></a>作者信息</h1><p>如果有不足或者错误的地方还望各位读者批评指正，可以评论留言，笔者收到后第一时间回复。</p>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">具体信息</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">QQ/微信</td>
<td style="text-align:center">hundreda</td>
</tr>
<tr>
<td style="text-align:center">简书号连接</td>
<td style="text-align:center"><a href="http://www.jianshu.com/users/a3ae6d7c68b6/latest_articles" target="_blank" rel="external">iOS-香蕉大大</a></td>
</tr>
<tr>
<td style="text-align:center">GitHub个人开源主页</td>
<td style="text-align:center"><a href="https://github.com/OneHundredSir" target="_blank" rel="external">GitHub连接</a></td>
</tr>
<tr>
<td style="text-align:center">好心人赏我个<code>赞</code></td>
<td style="text-align:center"><code>欢迎各位前来查看，star,感谢各位的阅读</code></td>
</tr>
<tr>
<td style="text-align:center">个人iOS开发QQ讨论群</td>
<td style="text-align:center"><strong>365204530</strong></td>
</tr>
<tr>
<td style="text-align:center"><code>群内规矩</code></td>
<td style="text-align:center"><code>聊天扯淡，讨论技术都行，没有什么群规，不懂就问</code></td>
</tr>
<tr>
<td style="text-align:center">iOS开发类微信订阅号</td>
<td style="text-align:center"><strong>大大家的IOS说</strong></td>
</tr>
<tr>
<td style="text-align:center"><em>微信扫一扫下面二维码</em></td>
<td style="text-align:center"><code>一起用碎片时间学习IOS吧</code></td>
</tr>
</tbody>
</table>
<p><img src="http://upload-images.jianshu.io/upload_images/1730495-755d908f00d77cf8.gif?imageMogr2/auto-orient/strip" alt="微信个人技术订阅号"><br>喜欢的朋友可以赏我2块大洋买糖吃～你的打赏是我前进的动力~一起做一个乐于分享的人吧~</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/iOS进阶/">iOS进阶</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/iOS黑魔法/">iOS黑魔法</a><a href="/tags/blockKit/">blockKit</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/20/IOS黑魔法/IOS开发---黑魔法之blocksKit分析(下)/" title="iOS开发---黑魔法之blocksKit分析(下)" itemprop="url">iOS开发---黑魔法之blocksKit分析(下)</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Hundred Wang" target="_blank" itemprop="author">Hundred Wang</a>
		
  <p class="article-time">
    <time datetime="2016-06-19T22:49:50.000Z" itemprop="datePublished"> 发表于 2016-06-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><ul>
<li>上篇链接:<a href="http://www.jianshu.com/p/1f6669ee0ddb" target="_blank" rel="external">IOS开发 - 黑魔法之blocksKit分析(上)</a></li>
<li>下篇链接:<a href="http://www.jianshu.com/p/59d2e8a77e05" target="_blank" rel="external">IOS开发 - 黑魔法之blocksKit分析(下)</a></li>
<li>应用篇含演示demo:<a href="http://www.jianshu.com/p/e9ff8c62781a" target="_blank" rel="external">IOS开发 - 黑魔法之blocksKit应用篇</a></li>
</ul>
<p>BlocksKit项目主页:<a href="https://github.com/zwaldowski/BlocksKit" target="_blank" rel="external">BlocksKit-github主页</a></p>
<hr>
<h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h1><p>本篇文章只适合对delegate和block进阶使用,不适合对以上两个概念的初学者学习.<br>高能预警：本篇文章非常长，因为 BlocksKit 的实现还是比较复杂和有意的。这篇文章不是为了剖析 iOS 开发中的 block 的实现以及它是如何组成甚至使用的，如果你想通过这篇文章来了解 block 的实现，它并不能帮到你。</p>
<p>Block 到底是什么？这可能是困扰很多 iOS 初学者的一个问题。如果你在 Google 上搜索类似的问题时，可以查找到几十万条结果，block 在 iOS 开发中有着非常重要的地位，而且它的作用也越来越重要。</p>
<hr>
<h1 id="私有类-BKObserver"><a href="#私有类-BKObserver" class="headerlink" title="私有类 _BKObserver"></a><strong>私有类 _BKObserver</strong></h1><p>_BKObserver 是用来观测属性的对象，它在接口中定义了 4 个属性：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>，<span class="keyword">readonly</span>，<span class="keyword">unsafe_unretained</span>) <span class="keyword">id</span> observee;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>，<span class="keyword">readonly</span>) <span class="built_in">NSMutableArray</span> *keyPaths;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>，<span class="keyword">readonly</span>) <span class="keyword">id</span> task;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>，<span class="keyword">readonly</span>) BKObserverContext context;</div></pre></td></tr></table></figure></p>
<p>上面四个属性的具体作用在这里不说了，上面的<br><code>bk_addObserverForKeyPaths:identifier:options:context:</code> 方法中调用_BKObserver 的初始化方法<br><code>initWithObservee:keyPaths:context:task:</code> 太简单了也不说了。</p>
<pre><code>_BKObserver *observer = [[_BKObserver alloc] initWithObservee:self keyPaths:keyPaths context:context task:task];
[observer startObservingWithOptions:options];
</code></pre><p>上面的第一行代码生成一个 observer 实例之后立刻调用了 <code>startObservingWithOptions:</code>方法开始观测对应的 keyPath：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)startObservingWithOptions:(<span class="built_in">NSKeyValueObservingOptions</span>)options</div><div class="line">&#123;</div><div class="line">    <span class="keyword">@synchronized</span>(<span class="keyword">self</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (_isObserving) <span class="keyword">return</span>;</div><div class="line">        </div><div class="line"><span class="meta">#1：遍历 keyPaths 实现 KVO</span></div><div class="line">        </div><div class="line">        _isObserving = <span class="literal">YES</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>startObservingWithOptions:</code>方法最重要的就是第 #1 部分：<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[<span class="keyword">self.keyPaths </span><span class="keyword">bk_each:^(NSString </span>*keyPath) &#123;</div><div class="line">    [<span class="keyword">self.observee </span><span class="keyword">addObserver:self </span>forKeyPath:keyPath options:options context:<span class="keyword">BKBlockObservationContext];</span></div><div class="line">&#125;]<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>遍历自己的 keyPaths 然后让 _BKObserver 作观察者观察自己，然后传入对应的 keyPath。</p>
<p>关于 <code>_stopObservingLocked</code>方法的实现也十分的相似，这里就不说了。<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[keyPaths bk_each:^(<span class="name">NSString</span> *keyPath) &#123;</div><div class="line">    [observee removeObserver:self forKeyPath:keyPath context:BKBlockObservationContext]<span class="comment">;</span></div><div class="line">&#125;]<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>到目前为止，我们还没有看到实现 KVO 所必须的方法 <code>observeValueForKeyPath:ofObject:change:context</code>，这个方法就是每次属性改变之后的回调：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span> *)change context:(<span class="keyword">void</span> *)context</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (context != BKBlockObservationContext) <span class="keyword">return</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">@synchronized</span>(<span class="keyword">self</span>) &#123;</div><div class="line">        <span class="keyword">switch</span> (<span class="keyword">self</span>.context) &#123;</div><div class="line">            <span class="keyword">case</span> BKObserverContextKey: &#123;</div><div class="line">                <span class="keyword">void</span> (^task)(<span class="keyword">id</span>) = <span class="keyword">self</span>.task;</div><div class="line">                task(object);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">case</span> BKObserverContextKeyWithChange: &#123;</div><div class="line">                <span class="keyword">void</span> (^task)(<span class="keyword">id</span>，<span class="built_in">NSDictionary</span> *) = <span class="keyword">self</span>.task;</div><div class="line">                task(object，change);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">case</span> BKObserverContextManyKeys: &#123;</div><div class="line">                <span class="keyword">void</span> (^task)(<span class="keyword">id</span>，<span class="built_in">NSString</span> *) = <span class="keyword">self</span>.task;</div><div class="line">                task(object，keyPath);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">case</span> BKObserverContextManyKeysWithChange: &#123;</div><div class="line">                <span class="keyword">void</span> (^task)(<span class="keyword">id</span>，<span class="built_in">NSString</span> *，<span class="built_in">NSDictionary</span> *) = <span class="keyword">self</span>.task;</div><div class="line">                task(object，keyPath，change);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个方法的实现也很简单，根据传入的 context 值，对 task 类型转换，并传入具体的值。</p>
<p>这个模块倒着就介绍完了，在下一节会介绍 BlocksKit 对 UIKit 组件一些简单的改造。</p>
<hr>
<h1 id="改造-UIKit"><a href="#改造-UIKit" class="headerlink" title="改造 UIKit"></a><strong>改造 UIKit</strong></h1><p>在这个小结会具体介绍 BlocksKit 是如何对一些简单的控件进行改造的，本节大约有两部分内容：</p>
<ul>
<li>UIGestureRecongizer + UIBarButtonItem + UIControl</li>
<li>UIView</li>
</ul>
<p>改造 UIGestureRecongizer，UIBarButtonItem 和 UIControl</p>
<p>先来看一个 UITapGestureRecognizer 使用的例子<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">UITapGestureRecognizer</span> *singleTap = [<span class="built_in">UITapGestureRecognizer</span> bk_recognizerWithHandler:^(<span class="keyword">id</span> sender) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Single tap."</span>);</div><div class="line">&#125; delay:<span class="number">0.18</span>];</div><div class="line">[<span class="keyword">self</span> addGestureRecognizer:singleTap];</div></pre></td></tr></table></figure></p>
<p>代码中的 <code>bk_recognizerWithHandler:delay:</code> 方法在最后都会调用初始化方法 <code>bk_initWithHandler:delay:</code> 生成一个UIGestureRecongizer 的实例<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">instancetype</span>)bk_initWithHandler:(<span class="keyword">void</span> (^)(<span class="built_in">UIGestureRecognizer</span> *sender，<span class="built_in">UIGestureRecognizerState</span> state，<span class="built_in">CGPoint</span> location))block delay:(<span class="built_in">NSTimeInterval</span>)delay</div><div class="line">&#123;</div><div class="line">    <span class="keyword">self</span> = [<span class="keyword">self</span> initWithTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(bk_handleAction:)];</div><div class="line">    <span class="keyword">if</span> (!<span class="keyword">self</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.bk_handler = block;</div><div class="line">    <span class="keyword">self</span>.bk_handlerDelay = delay;</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>它会在这个方法中传入 target 和 selector。 其中 target 就是 self，而 selector 也会在这个分类中实现：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)bk_handleAction:(<span class="built_in">UIGestureRecognizer</span> *)recognizer</div><div class="line">&#123;</div><div class="line">    <span class="keyword">void</span> (^handler)(<span class="built_in">UIGestureRecognizer</span> *sender，<span class="built_in">UIGestureRecognizerState</span> state，<span class="built_in">CGPoint</span> location) = recognizer.bk_handler;</div><div class="line">    <span class="keyword">if</span> (!handler) <span class="keyword">return</span>;</div><div class="line">    </div><div class="line">    <span class="built_in">NSTimeInterval</span> delay = <span class="keyword">self</span>.bk_handlerDelay;</div><div class="line">    </div><div class="line"><span class="meta">#1: 封装 block 并控制 block 是否可以执行</span></div><div class="line">    </div><div class="line">    <span class="keyword">self</span>.bk_shouldHandleAction = <span class="literal">YES</span>;</div><div class="line">    </div><div class="line">    [<span class="built_in">NSObject</span> bk_performAfterDelay:delay usingBlock:block];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>因为在初始化方法 bk_initWithHandler:delay: 中保存了当前手势的 bk_handler，所以直接调用在 Block Execution 一节中提到过的 bk_performAfterDelay:usingBlock: 方法，将 block 派发到指定的队列中，最终完成对 block 的调用。</p>
<h1 id="封装-block-并控制-block-是否可以执行"><a href="#封装-block-并控制-block-是否可以执行" class="headerlink" title="封装 block 并控制 block 是否可以执行"></a><strong>封装 block 并控制 block 是否可以执行</strong></h1><p>这部分代码和前面的部分有些相似，因为这里也用到了一个属性 bk_shouldHandleAction 来控制 block 是否会被执行：<br><figure class="highlight pf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">CGPoint location = [<span class="literal">self</span> locationInView:<span class="literal">self</span>.view];</div><div class="line">void (^<span class="built_in">block</span>)(void) = ^&#123;</div><div class="line">    if (!<span class="literal">self</span>.bk_shouldHandleAction) return;</div><div class="line">    handler(<span class="literal">self</span>，<span class="literal">self</span>.<span class="keyword">state</span>，location);</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>同样 UIBarButtonItem 和 UIControl 也是用了几乎相同的机制，把 target 设置为 self，让后在分类的方法中调用指定的 block。</p>
<h1 id="UIControlWrapper"><a href="#UIControlWrapper" class="headerlink" title="UIControlWrapper"></a><strong>UIControlWrapper</strong></h1><p>稍微有些不同的是 UIControl。因为 UIControl 有多种 UIControlEvents，所以使用另一个类 BKControlWrapper 来封装handler 和 controlEvents<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">UIControlEvents</span> controlEvents;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>，<span class="keyword">copy</span>) <span class="keyword">void</span> (^handler)(<span class="keyword">id</span> sender);</div></pre></td></tr></table></figure></p>
<p>其中 UIControlWrapper 对象以 {controlEvents，wrapper} 的形式作为 UIControl 的属性存入字典。</p>
<blockquote>
<p>改造 UIView</p>
</blockquote>
<p>因为在上面已经改造过了 UIGestureRecognizer，在这里改造 UIView 就变得很容易了：<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)bk_whenTouches:(<span class="built_in">NSUInteger</span>)numberOfTouches tapped:(<span class="built_in">NSUInteger</span>)numberOfTaps handler:(<span class="keyword">void</span> (^)(<span class="keyword">void</span>))block</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (!block) <span class="keyword">return</span>;</div><div class="line">    </div><div class="line">    <span class="built_in">UITapGestureRecognizer</span> *gesture = [<span class="built_in">UITapGestureRecognizer</span> bk_recognizerWithHandler:^(<span class="built_in">UIGestureRecognizer</span> *sender，<span class="built_in">UIGestureRecognizerState</span> state，<span class="built_in">CGPoint</span> location) &#123;</div><div class="line">        <span class="keyword">if</span> (state == <span class="built_in">UIGestureRecognizerStateRecognized</span>) block();</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    gesture.numberOfTouchesRequired = numberOfTouches;</div><div class="line">    gesture.numberOfTapsRequired = numberOfTaps;</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span>.gestureRecognizers enumerateObjectsUsingBlock:^(<span class="keyword">id</span> obj，<span class="built_in">NSUInteger</span> idx，<span class="built_in">BOOL</span> *stop) &#123;</div><div class="line">        <span class="keyword">if</span> (![obj isKindOfClass:[<span class="built_in">UITapGestureRecognizer</span> <span class="keyword">class</span>]]) <span class="keyword">return</span>;</div><div class="line">        </div><div class="line">        <span class="built_in">UITapGestureRecognizer</span> *tap = obj;</div><div class="line">        <span class="built_in">BOOL</span> rightTouches = (tap.numberOfTouchesRequired == numberOfTouches);</div><div class="line">        <span class="built_in">BOOL</span> rightTaps = (tap.numberOfTapsRequired == numberOfTaps);</div><div class="line">        <span class="keyword">if</span> (rightTouches &amp;&amp; rightTaps) &#123;</div><div class="line">            [gesture requireGestureRecognizerToFail:tap];</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span> addGestureRecognizer:gesture];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>UIView 分类只有这一个核心方法，其它的方法都是向这个方法传入不同的参数，这里需要注意的就是。它会遍历所有的gestureRecognizers，然后把对所有有冲突的手势调用 requireGestureRecognizerToFail: 方法，保证添加的手势能够正常的执行。</p>
<hr>
<h1 id="作者信息"><a href="#作者信息" class="headerlink" title="作者信息"></a>作者信息</h1><p>如果有不足或者错误的地方还望各位读者批评指正，可以评论留言，笔者收到后第一时间回复。</p>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">具体信息</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">QQ/微信</td>
<td style="text-align:center">hundreda</td>
</tr>
<tr>
<td style="text-align:center">简书号连接</td>
<td style="text-align:center"><a href="http://www.jianshu.com/users/a3ae6d7c68b6/latest_articles" target="_blank" rel="external">iOS-香蕉大大</a></td>
</tr>
<tr>
<td style="text-align:center">GitHub个人开源主页</td>
<td style="text-align:center"><a href="https://github.com/OneHundredSir" target="_blank" rel="external">GitHub连接</a></td>
</tr>
<tr>
<td style="text-align:center">好心人赏我个<code>赞</code></td>
<td style="text-align:center"><code>欢迎各位前来查看，star,感谢各位的阅读</code></td>
</tr>
<tr>
<td style="text-align:center">个人iOS开发QQ讨论群</td>
<td style="text-align:center"><strong>365204530</strong></td>
</tr>
<tr>
<td style="text-align:center"><code>群内规矩</code></td>
<td style="text-align:center"><code>聊天扯淡，讨论技术都行，没有什么群规，不懂就问</code></td>
</tr>
<tr>
<td style="text-align:center">iOS开发类微信订阅号</td>
<td style="text-align:center"><strong>大大家的IOS说</strong></td>
</tr>
<tr>
<td style="text-align:center"><em>微信扫一扫下面二维码</em></td>
<td style="text-align:center"><code>一起用碎片时间学习IOS吧</code></td>
</tr>
</tbody>
</table>
<p><img src="http://upload-images.jianshu.io/upload_images/1730495-755d908f00d77cf8.gif?imageMogr2/auto-orient/strip" alt="微信个人技术订阅号"><br>喜欢的朋友可以赏我2块大洋买糖吃～你的打赏是我前进的动力~一起做一个乐于分享的人吧~</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/iOS进阶/">iOS进阶</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/iOS黑魔法/">iOS黑魔法</a><a href="/tags/blockKit/">blockKit</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/20/IOS黑魔法/IOS开发---黑魔法之blocksKit应用篇(含demo)/" title="黑魔法之blocksKit应用篇(含demo)" itemprop="url">黑魔法之blocksKit应用篇(含demo)</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Hundred Wang" target="_blank" itemprop="author">Hundred Wang</a>
		
  <p class="article-time">
    <time datetime="2016-06-19T22:49:50.000Z" itemprop="datePublished"> 发表于 2016-06-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><ul>
<li>上篇链接:<a href="http://www.jianshu.com/p/1f6669ee0ddb" target="_blank" rel="external">IOS开发 - 黑魔法之blocksKit分析(上)</a></li>
<li>下篇链接:<a href="http://www.jianshu.com/p/59d2e8a77e05" target="_blank" rel="external">IOS开发 - 黑魔法之blocksKit分析(下)</a></li>
<li>应用篇含演示demo:<a href="http://www.jianshu.com/p/e9ff8c62781a" target="_blank" rel="external">IOS开发 - 黑魔法之blocksKit应用篇</a></li>
</ul>
<p>BlocksKit项目主页:<a href="https://github.com/zwaldowski/BlocksKit" target="_blank" rel="external">BlocksKit-github主页</a></p>
<hr>
<h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h1><p>本篇文章只适合对delegate和block实战还不错的朋友所进行讲解,不懂的先去学习以上基础用法.</p>
<h1 id="2-blocksKit的核心内容-如何用block充当代理的好旗手"><a href="#2-blocksKit的核心内容-如何用block充当代理的好旗手" class="headerlink" title="2.blocksKit的核心内容(如何用block充当代理的好旗手)"></a>2.blocksKit的核心内容(如何用block充当代理的好旗手)</h1><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//手势和按钮的实现原理</span></div><div class="line">- (<span class="keyword">id</span>)bk_initWithHandler:(<span class="keyword">void</span> (^)(<span class="built_in">UIGestureRecognizer</span> *sender, <span class="built_in">UIGestureRecognizerState</span> state, <span class="built_in">CGPoint</span> location))block delay:(<span class="built_in">NSTimeInterval</span>)delay</div><div class="line">&#123;</div><div class="line"> <span class="keyword">self</span> = [<span class="keyword">self</span> initWithTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(bk_handleAction:)];</div><div class="line"> <span class="keyword">if</span> (!<span class="keyword">self</span>) <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line"></div><div class="line"> <span class="keyword">self</span>.bk_handler = block;</div><div class="line"> <span class="keyword">self</span>.bk_handlerDelay = delay;</div><div class="line"></div><div class="line"> <span class="keyword">return</span> <span class="keyword">self</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//按钮的实现原理</span></div><div class="line">- (<span class="keyword">void</span>)bk_addEventHandler:(<span class="keyword">void</span> (^)(<span class="keyword">id</span> sender))handler forControlEvents:(<span class="built_in">UIControlEvents</span>)controlEvents</div><div class="line">&#123;</div><div class="line"> <span class="built_in">NSParameterAssert</span>(handler);</div><div class="line"> </div><div class="line"> <span class="built_in">NSMutableDictionary</span> *events = objc_getAssociatedObject(<span class="keyword">self</span>, BKControlHandlersKey);</div><div class="line"> <span class="keyword">if</span> (!events) &#123;</div><div class="line">  events = [<span class="built_in">NSMutableDictionary</span> dictionary];</div><div class="line">  objc_setAssociatedObject(<span class="keyword">self</span>, BKControlHandlersKey, events, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="built_in">NSNumber</span> *key = @(controlEvents);</div><div class="line"> <span class="built_in">NSMutableSet</span> *handlers = events[key];</div><div class="line"> <span class="keyword">if</span> (!handlers) &#123;</div><div class="line">  handlers = [<span class="built_in">NSMutableSet</span> set];</div><div class="line">  events[key] = handlers;</div><div class="line"> &#125;</div><div class="line"> </div><div class="line"> BKControlWrapper *target = [[BKControlWrapper alloc] initWithHandler:handler forControlEvents:controlEvents];</div><div class="line"> [handlers addObject:target];</div><div class="line"> [<span class="keyword">self</span> addTarget:target action:<span class="keyword">@selector</span>(invoke:) forControlEvents:controlEvents];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h1 id="作者信息"><a href="#作者信息" class="headerlink" title="作者信息"></a>作者信息</h1><p>如果有不足或者错误的地方还望各位读者批评指正，可以评论留言，笔者收到后第一时间回复。</p>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">具体信息</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">QQ/微信</td>
<td style="text-align:center">hundreda</td>
</tr>
<tr>
<td style="text-align:center">简书号连接</td>
<td style="text-align:center"><a href="http://www.jianshu.com/users/a3ae6d7c68b6/latest_articles" target="_blank" rel="external">iOS-香蕉大大</a></td>
</tr>
<tr>
<td style="text-align:center">GitHub个人开源主页</td>
<td style="text-align:center"><a href="https://github.com/OneHundredSir" target="_blank" rel="external">GitHub连接</a></td>
</tr>
<tr>
<td style="text-align:center">好心人赏我个<code>赞</code></td>
<td style="text-align:center"><code>欢迎各位前来查看，star,感谢各位的阅读</code></td>
</tr>
<tr>
<td style="text-align:center">个人iOS开发QQ讨论群</td>
<td style="text-align:center"><strong>365204530</strong></td>
</tr>
<tr>
<td style="text-align:center"><code>群内规矩</code></td>
<td style="text-align:center"><code>聊天扯淡，讨论技术都行，没有什么群规，不懂就问</code></td>
</tr>
<tr>
<td style="text-align:center">iOS开发类微信订阅号</td>
<td style="text-align:center"><strong>大大家的IOS说</strong></td>
</tr>
<tr>
<td style="text-align:center"><em>微信扫一扫下面二维码</em></td>
<td style="text-align:center"><code>一起用碎片时间学习IOS吧</code></td>
</tr>
</tbody>
</table>
<p><img src="http://upload-images.jianshu.io/upload_images/1730495-755d908f00d77cf8.gif?imageMogr2/auto-orient/strip" alt="微信个人技术订阅号"><br>喜欢的朋友可以赏我2块大洋买糖吃～你的打赏是我前进的动力~一起做一个乐于分享的人吧~</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/iOS进阶/">iOS进阶</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/iOS黑魔法/">iOS黑魔法</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/05/20/IOS黑魔法/IOS开发-黑魔法之IBDesignable-IBInspectable可视化效果编程/" title="IBDesignable-IBInspectable可视化效果编程" itemprop="url">IBDesignable-IBInspectable可视化效果编程</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Hundred Wang" target="_blank" itemprop="author">Hundred Wang</a>
		
  <p class="article-time">
    <time datetime="2016-05-19T22:49:50.000Z" itemprop="datePublished"> 发表于 2016-05-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>我们好像慢慢地习惯了“理想很丰满，现实很骨感”这样顺序这样的转折这样常态，那么如果是“现实很丰满，理想很骨感”，我们能接受吗？现实丰满可以，但是理想很骨感那就不要将就了。就像薛之谦希望是能通过“丑八怪 呀啊呀啊呀哎呀”来唱红的自己，而不是上综艺做直男直到没朋友的谐星来笑红自己却跟他的歌关系不大。</p>
<p>苹果开发中使用的XCode也有这样的“现实丰满，理想骨感”例子，苹果公司在2011年就推出了UIStoryboard技术，到现在已经6年了。苹果还不在xcode的Interface Builder上直接提供修改控件的圆角，边框设置，而是提供IBDesignable/IBInspectable这样的技术让这些重复简单的工作由开发者来实现圆角外框，最后category上使用IBDesignable/IBInspectable却不能直接现实想要的结果。</p>
<p>那边我们来体验一下薛之谦的“人红歌不红”的“现实很丰满，理想很骨感”感觉。</p>
<p><img src="http://ww2.sinaimg.cn/mw690/006yX0Ypgw1f9ptuwysmsj30hs05qdg7.jpg" alt="文章思维导图"></p>
<h1 id="一-我们想要很简单"><a href="#一-我们想要很简单" class="headerlink" title="一.我们想要很简单"></a><strong>一.我们想要很简单</strong></h1><p>在Storyboard中的所有控件能通过Interface builder直接设置最基本圆角，边框和边框颜色属性，表达理想的Storyboard能显示出我要的渲染效果，而不是编写代码后只能在运行在手机或模拟器时才出现我们想要的效果。就像薛之谦想通唱歌红了自己，简单明了。</p>
<h1 id="二-基本概念"><a href="#二-基本概念" class="headerlink" title="二.基本概念"></a><strong>二.基本概念</strong></h1><p>IB_DESIGNABLE的宏的功能就是让XCode动态渲染出该类图形化界面。UIView 或 NSView使用IB_DESIGNABLE宏声明时候，就是让Interface Builder知道它应该在UIStoryboard或者Xib中画布上直接渲染视图，不需要等到编译运行后就能预先展示出来效果 。</p>
<p>IBInspectable修饰属性，可以是用户自定义的运行时属性，让支持KVC的属性能够在Attribute Inspector中配置。</p>
<h1 id="三-使用方式"><a href="#三-使用方式" class="headerlink" title="三.使用方式"></a><strong>三.使用方式</strong></h1><h2 id="1-IB-DESIGNABLE放在-interface或者-implement都可以，申明这个类在XCode直接看到渲染的效果。"><a href="#1-IB-DESIGNABLE放在-interface或者-implement都可以，申明这个类在XCode直接看到渲染的效果。" class="headerlink" title="1.IB_DESIGNABLE放在@interface或者@implement都可以，申明这个类在XCode直接看到渲染的效果。"></a>1.IB_DESIGNABLE放在@interface或者@implement都可以，申明这个类在XCode直接看到渲染的效果。</h2><p>IB_DESIGNABLE<br>@interface IBDesignableImageView : UIImageView</p>
<h2 id="2-IBInspectable-修饰属性，使属性能在XCode中直接设置。"><a href="#2-IBInspectable-修饰属性，使属性能在XCode中直接设置。" class="headerlink" title="2.IBInspectable 修饰属性，使属性能在XCode中直接设置。**"></a>2.IBInspectable 修饰属性，使属性能在XCode中直接设置。**</h2><p>@property(nonatomic,assign) IBInspectable CGFloat cornerRadius;</p>
<h1 id="四-普通类继承关系实现渲染效果"><a href="#四-普通类继承关系实现渲染效果" class="headerlink" title="四 .普通类继承关系实现渲染效果"></a><strong>四 .普通类继承关系实现渲染效果</strong></h1><p>根据第三所列出的2个关键点，详细具体实现：</p>
<h2 id="1-自定义IBDesignableImageView-继承UIImageView。"><a href="#1-自定义IBDesignableImageView-继承UIImageView。" class="headerlink" title="1.自定义IBDesignableImageView 继承UIImageView。"></a>1.自定义IBDesignableImageView 继承UIImageView。</h2><p>#import<br>IB_DESIGNABLE<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> <span class="attribute">IBDesignableImageView </span>: UIImageView</div><div class="line">    <span class="variable">@property</span>(nonatomic,assign) IBInspectable CGFloat cornerRadius;</div><div class="line"><span class="variable">@end</span></div></pre></td></tr></table></figure></p>
<h2 id="2-接着在IBDesignableImageView-m文件实现下set方法"><a href="#2-接着在IBDesignableImageView-m文件实现下set方法" class="headerlink" title="2.接着在IBDesignableImageView.m文件实现下set方法"></a>2.接着在IBDesignableImageView.m文件实现下set方法</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">"IBDesignableImageView.h"</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">IBDesignableImageView</span></span></div><div class="line">-(<span class="keyword">void</span>)setCornerRadius:(<span class="built_in">CGFloat</span>)cornerRadius&#123;</div><div class="line">    _cornerRadius = cornerRadius;<span class="comment">//不要使用self.cornerRadius = cornerRadius;这样会死循环</span></div><div class="line">    <span class="keyword">self</span>.layer.masksToBounds = <span class="literal">YES</span>;</div><div class="line">    <span class="keyword">self</span>.layer.cornerRadius = cornerRadius;</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<h2 id="3-接着，XCode中Customer-Class选择IBDesignableImageView。"><a href="#3-接着，XCode中Customer-Class选择IBDesignableImageView。" class="headerlink" title="3.接着，XCode中Customer Class选择IBDesignableImageView。"></a>3.接着，XCode中Customer Class选择IBDesignableImageView。</h2><h2 id="4-最后，interface-builder属性栏中设置你刚刚属性。"><a href="#4-最后，interface-builder属性栏中设置你刚刚属性。" class="headerlink" title="4.最后，interface builder属性栏中设置你刚刚属性。"></a>4.最后，interface builder属性栏中设置你刚刚属性。</h2><p><img src="http://ww4.sinaimg.cn/mw690/006yX0Ypgw1f9ptuxehuvj30hs05aq2w.jpg" alt="类继承关系实现效果图"></p>
<p>主要就是以上四步基本满足一下下storyboard成功展示一种View实时渲染效果<br>的快感，犹如薛之谦尝试到一首《丑八怪》火一阵子，爽一阵子的快感，并且不会让人误认为这是赵全的《我很丑可是我很温柔》的续本。</p>
<h1 id="五-UIView的Category实现渲染效果"><a href="#五-UIView的Category实现渲染效果" class="headerlink" title="五.UIView的Category实现渲染效果"></a><strong>五.UIView的Category实现渲染效果</strong></h1><p>尝到了好处，自然想到实现通用的方式给需要控件都加上interface builder可设置相关属性。所以，我们自认为UIView其他子View父类，那么如果UIView可是直接在XCode上设置属性实现渲染，那么其他子View随之得到渲染效果。</p>
<h2 id="1-我们最想看到的结果是"><a href="#1-我们最想看到的结果是" class="headerlink" title="1.我们最想看到的结果是"></a>1.我们最想看到的结果是</h2><p>我们最想看到结果是，UIImageView、UITextField、UIButton等等都能如愿的被interface builder直接修改相关圆角，边框等等属性。噔噔，我们脑海浮现以下画面：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1730495-4b58572f9f2ac222.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="最理想状态"></p>
<h2 id="2-编写UIView的Category类UIView-MGO-h"><a href="#2-编写UIView的Category类UIView-MGO-h" class="headerlink" title="2.编写UIView的Category类UIView+MGO.h"></a>2.编写UIView的Category类UIView+MGO.h</h2><p>#import<br>IB_DESIGNABLE<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="variable">@interface</span> UIView (MGO)</div><div class="line">    <span class="variable">@property</span>(nonatomic,assign) IBInspectable CGFloat cornerRadius;</div><div class="line">    <span class="variable">@property</span>(nonatomic,assign) IBInspectable CGFloat borderWidth;</div><div class="line">    <span class="variable">@property</span>(nonatomic,assign) IBInspectable UIColor *borderColor;</div><div class="line">    <span class="variable">@property</span>(nonatomic,assign) IBInspectable CGFloat defineValue;</div><div class="line"><span class="variable">@end</span></div></pre></td></tr></table></figure></p>
<h2 id="3-编写UIView-MGO-m中的实现"><a href="#3-编写UIView-MGO-m中的实现" class="headerlink" title="3.编写UIView+MGO.m中的实现"></a>3.编写UIView+MGO.m中的实现</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">"UIView+MGO.h"</span></span></div><div class="line"><span class="meta">#import </span></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIView</span> (<span class="title">MGO</span>)</span></div><div class="line">-(<span class="keyword">void</span>)setCornerRadius:(<span class="built_in">CGFloat</span>)cornerRadius&#123;</div><div class="line">    <span class="keyword">self</span>.layer.masksToBounds = <span class="literal">YES</span>;</div><div class="line">    <span class="keyword">self</span>.layer.cornerRadius = cornerRadius;</div><div class="line">&#125;</div><div class="line">-(<span class="keyword">void</span>)setBorderColor:(<span class="built_in">UIColor</span> *)borderColor&#123;</div><div class="line">    <span class="keyword">self</span>.layer.borderColor = borderColor.CGColor;</div><div class="line">&#125;</div><div class="line">-(<span class="keyword">void</span>)setBorderWidth:(<span class="built_in">CGFloat</span>)borderWidth&#123;</div><div class="line">    <span class="keyword">self</span>.layer.borderWidth = borderWidth;</div><div class="line">&#125;</div><div class="line">-(<span class="keyword">void</span>)setDefineValue:(<span class="built_in">CGFloat</span>)defineValue&#123;</div><div class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(defineValue), @(defineValue),OBJC_ASSOCIATION_ASSIGN);</div><div class="line">&#125;</div><div class="line">-(<span class="built_in">CGFloat</span>)cornerRadius&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.layer.cornerRadius;</div><div class="line">&#125;</div><div class="line">-(<span class="built_in">CGFloat</span>)borderWidth&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">self</span>.layer.borderWidth;</div><div class="line">&#125;</div><div class="line">-(<span class="built_in">UIColor</span> *)borderColor&#123;</div><div class="line">    <span class="keyword">return</span> [<span class="built_in">UIColor</span> colorWithCGColor:<span class="keyword">self</span>.layer.borderColor];</div><div class="line">&#125;</div><div class="line">-(<span class="built_in">CGFloat</span>)defineValue&#123;</div><div class="line">    <span class="keyword">return</span> [objc_getAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(defineValue)) floatValue];</div><div class="line">&#125;</div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>这个.m的实现类，有几个知识点要注意：</p>
<h3 id="1-category中添加IBInspectable修饰属性，必须带有set和get的方法，不然编译都通过。"><a href="#1-category中添加IBInspectable修饰属性，必须带有set和get的方法，不然编译都通过。" class="headerlink" title="1).category中添加IBInspectable修饰属性，必须带有set和get的方法，不然编译都通过。"></a>1).category中添加IBInspectable修饰属性，必须带有set和get的方法，不然编译都通过。</h3><h3 id="2-KVC观察属性值变化，从而得到即时刷新效果。"><a href="#2-KVC观察属性值变化，从而得到即时刷新效果。" class="headerlink" title="2).KVC观察属性值变化，从而得到即时刷新效果。"></a>2).KVC观察属性值变化，从而得到即时刷新效果。</h3><h3 id="3-category中自定义属性如上边defineValue属性，使用runtime方式赋值。所以会有objc-setAssociatedObject-self-selector-defineValue-defineValue-OBJC-ASSOCIATION-ASSIGN-这样的代码。-defineValue-defineValue-这样也是行，这样是有语法问题的。"><a href="#3-category中自定义属性如上边defineValue属性，使用runtime方式赋值。所以会有objc-setAssociatedObject-self-selector-defineValue-defineValue-OBJC-ASSOCIATION-ASSIGN-这样的代码。-defineValue-defineValue-这样也是行，这样是有语法问题的。" class="headerlink" title="3).category中自定义属性如上边defineValue属性，使用runtime方式赋值。所以会有objc_setAssociatedObject(self, @selector(defineValue), @(defineValue),OBJC_ASSOCIATION_ASSIGN);这样的代码。_defineValue = defineValue;这样也是行，这样是有语法问题的。"></a>3).category中自定义属性如上边defineValue属性，使用runtime方式赋值。所以会有objc_setAssociatedObject(self, @selector(defineValue), @(defineValue),OBJC_ASSOCIATION_ASSIGN);这样的代码。_defineValue = defineValue;这样也是行，这样是有语法问题的。</h3><p>详细的runtime和KVC知识点可以查看《谈Runtime机制和使用的整体化梳理》和《谈KVC、KVO（重点观察者模式）机制编程》</p>
<h2 id="4-在interface-builder设置相关属性"><a href="#4-在interface-builder设置相关属性" class="headerlink" title="4.在interface builder设置相关属性"></a>4.在interface builder设置相关属性</h2><h3 id="1-属性栏可以看可设置圆角，边框宽度等"><a href="#1-属性栏可以看可设置圆角，边框宽度等" class="headerlink" title="1).属性栏可以看可设置圆角，边框宽度等"></a>1).属性栏可以看可设置圆角，边框宽度等</h3><p><img src="http://ww3.sinaimg.cn/mw690/006yX0Ypgw1f9ptux8uh5j30au0900sw.jpg" alt="设置UIView(MGO定义出来属性)"></p>
<h3 id="2-Runtime-Attribute栏中也能自动生成刚刚设置的属性值"><a href="#2-Runtime-Attribute栏中也能自动生成刚刚设置的属性值" class="headerlink" title="2).Runtime Attribute栏中也能自动生成刚刚设置的属性值"></a>2).Runtime Attribute栏中也能自动生成刚刚设置的属性值</h3><p><img src="http://ww1.sinaimg.cn/mw690/006yX0Ypgw1f9ptuxzcmmj30h609hjrw.jpg" alt="Runtime Attribute显示属性值"></p>
<h2 id="5-查看storyboard上的头像有没有显示设置的属性值"><a href="#5-查看storyboard上的头像有没有显示设置的属性值" class="headerlink" title="5.查看storyboard上的头像有没有显示设置的属性值"></a>5.查看storyboard上的头像有没有显示设置的属性值</h2><p><img src="http://ww3.sinaimg.cn/mw690/006yX0Ypgw1f9ptuybsbhj30hs0dt3z4.jpg" alt="UIView(MGO)展示的效果"></p>
<p>Oh。。。my god！storyboard上一点效果也没显示出来，反而模拟器运行效果确实理想的状态。活生生的“现实很丰满，理想很骨感”表现得淋漓尽致。难道要硬着头皮瞬间退回到解放前，重复不断的写继承代码。。。打死也不，，，告诉你淘宝发过来的验证码！</p>
<h1 id="六-曲线救国处理Category不显示效果问题"><a href="#六-曲线救国处理Category不显示效果问题" class="headerlink" title="六.曲线救国处理Category不显示效果问题"></a><strong>六.曲线救国处理Category不显示效果问题</strong></h1><p>曲线救国生活中可以，国就是救那么一两次，没国了也没办法。程序中，每时每刻都在救国，明摆着这欺负人嘛！不过，国我们还是得救的，歌薛之谦还是要唱的，先找到两者的微妙关系，串成曲线才行。于是乎，薛之谦将段子手的头衔发挥到极致，参加各大综艺，《火星情报站》《极限挑战》《大学生来了》等等，趁机唱唱“丑八怪 呀啊呀啊哎呀”，道理就明了了，就是死活出现在人面前晃来晃去。</p>
<p>哟，那会不会interface builder死活要看到UIView的自定义子类的继承类，设置在Customer Class中才行啊。试试？</p>
<h2 id="1-编写一个-空白MGOImageView继承UIImageView。"><a href="#1-编写一个-空白MGOImageView继承UIImageView。" class="headerlink" title="1.编写一个 空白MGOImageView继承UIImageView。"></a>1.编写一个 空白MGOImageView继承UIImageView。</h2><figure class="highlight monkey"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import </span></div><div class="line">@<span class="class"><span class="keyword">interface</span> <span class="title">MGOImageView</span> : <span class="title">UIImageView</span></span></div><div class="line">@<span class="keyword">end</span></div></pre></td></tr></table></figure>
<h2 id="2-MGOImageView-m文件什么也不干，就是等机会对接UIView-MGO-自定义属性。"><a href="#2-MGOImageView-m文件什么也不干，就是等机会对接UIView-MGO-自定义属性。" class="headerlink" title="2.MGOImageView.m文件什么也不干，就是等机会对接UIView(MGO)自定义属性。"></a>2.MGOImageView.m文件什么也不干，就是等机会对接UIView(MGO)自定义属性。</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">"MGOImageView.h"</span></span></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">MGOImageView</span></span></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<h2 id="3-选中storyboard中的UIImageView在Customer-Class选择-MGOImageView。"><a href="#3-选中storyboard中的UIImageView在Customer-Class选择-MGOImageView。" class="headerlink" title="3.选中storyboard中的UIImageView在Customer Class选择 MGOImageView。"></a>3.选中storyboard中的UIImageView在Customer Class选择 MGOImageView。</h2><p><img src="http://upload-images.jianshu.io/upload_images/1730495-22d2c13a4eea9e5f?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="编写空白MGOImageView尝试"></p>
<p>噢，，，了个天啊！storyboard上一点效果都没有少显示出来，反而吓到了现实中的我。那就趁热吃豆腐了，把其他控件都写一个对应空白的子类，设置在customer class上。<br><img src="http://upload-images.jianshu.io/upload_images/1730495-f32a5e310136da21?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>其他控件都添加对应的子类</p>
<p>好像幸福就是来得那么突然，伤心的小船说翻就翻了。会不会有更大幸福，于是乎，小明在google上搜索“IBDesignable/IBInspectable在Category中没有效果”。看了两三页搜索结果，最后比较接近的是Cocachina中也有一个没有人回复的相关帖子，和另外一篇跟我的发现一样要写一个空白的子类设置在Customer Class 中才行。</p>
<h1 id="七-对比总结"><a href="#七-对比总结" class="headerlink" title="七.对比总结"></a><strong>七.对比总结</strong></h1><p>经过以上一系列折腾，最后的结果确认令我觉得“不完美的IBDesignable/IBInspectable”。有些对XCode，Storyboard项目者有些一丁点的期待外，同时也是希望有开发者提供更好的处理方式。对比其他IDE，，就算了。追求完美我们是天生的，尽情开发我们也是认真的。</p>
<h1 id="八-源码下载"><a href="#八-源码下载" class="headerlink" title="八.源码下载"></a><strong>八.源码下载</strong></h1><p><a href="https://github.com/minggo620/iOSDesignable.git" target="_blank" rel="external">https://github.com/minggo620/iOSDesignable.git</a></p>
<blockquote>
<p>作者信息</p>
</blockquote>
<p>如果有不足或者错误的地方还望各位读者批评指正，可以评论留言，笔者收到后第一时间回复。</p>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">具体信息</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">QQ/微信</td>
<td style="text-align:center">hundreda</td>
</tr>
<tr>
<td style="text-align:center">简书号连接</td>
<td style="text-align:center"><a href="http://www.jianshu.com/users/a3ae6d7c68b6/latest_articles" target="_blank" rel="external">iOS-香蕉大大</a></td>
</tr>
<tr>
<td style="text-align:center">GitHub个人开源主页</td>
<td style="text-align:center"><a href="https://github.com/OneHundredSir" target="_blank" rel="external">GitHub连接</a></td>
</tr>
<tr>
<td style="text-align:center">好心人赏我个<code>赞</code></td>
<td style="text-align:center"><code>欢迎各位前来查看，star,感谢各位的阅读</code></td>
</tr>
<tr>
<td style="text-align:center">个人iOS开发QQ讨论群</td>
<td style="text-align:center"><strong>365204530</strong></td>
</tr>
<tr>
<td style="text-align:center"><code>群内规矩</code></td>
<td style="text-align:center"><code>聊天扯淡，讨论技术都行，没有什么群规，不懂就问</code></td>
</tr>
<tr>
<td style="text-align:center">iOS开发类微信订阅号</td>
<td style="text-align:center"><strong>大大家的IOS说</strong></td>
</tr>
<tr>
<td style="text-align:center"><em>微信扫一扫下面二维码</em></td>
<td style="text-align:center"><code>一起用碎片时间学习IOS吧</code></td>
</tr>
</tbody>
</table>
<p><img src="http://upload-images.jianshu.io/upload_images/1730495-755d908f00d77cf8.gif?imageMogr2/auto-orient/strip" alt="微信个人技术订阅号"><br>喜欢的朋友可以赏我2块大洋买糖吃～你的打赏是我前进的动力~一起做一个乐于分享的人吧~</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/iOS进阶/">iOS进阶</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/iOS黑魔法/">iOS黑魔法</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/05/20/IOS黑魔法/IOS开发---网络状态检测（Reachability）含Demo/" title="网络状态检测（Reachability）含Demo" itemprop="url">网络状态检测（Reachability）含Demo</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Hundred Wang" target="_blank" itemprop="author">Hundred Wang</a>
		
  <p class="article-time">
    <time datetime="2016-05-19T22:49:50.000Z" itemprop="datePublished"> 发表于 2016-05-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>文章最后附上本次讲解的Demo以及演示动态图：<a href="https://github.com/OneHundredSir/Objective-C/tree/master/webtest" target="_blank" rel="external">GithubDemo</a></p>
<h1 id="一、说明"><a href="#一、说明" class="headerlink" title="一、说明"></a><strong>一、说明</strong></h1><p>在网络应用中，需要对用户设备的网络状态进行实时监控，有两个目的：</p>
<h2 id="（1）让用户了解自己的网络状态，防止一些误会（比如怪应用无能）"><a href="#（1）让用户了解自己的网络状态，防止一些误会（比如怪应用无能）" class="headerlink" title="（1）让用户了解自己的网络状态，防止一些误会（比如怪应用无能）"></a>（1）让用户了解自己的网络状态，防止一些误会（比如怪应用无能）</h2><h2 id="（2）根据用户的网络状态进行智能处理，节省用户流量，提高用户体验"><a href="#（2）根据用户的网络状态进行智能处理，节省用户流量，提高用户体验" class="headerlink" title="（2）根据用户的网络状态进行智能处理，节省用户流量，提高用户体验"></a>（2）根据用户的网络状态进行智能处理，节省用户流量，提高用户体验</h2><p>　　  WIFI\3G网络：自动下载高清图片<br>　　  低速网络：只下载缩略图<br>　　  没有网络：只显示离线的缓存数据<br>iOS7以前苹果官方提供了一个叫Reachability的示例程序，便于开发者检测网络状态<br>连接:<a href="https://developer.apple.com/library/ios/samplecode/Reachability/Reachability.zip" target="_blank" rel="external">官方演示连接</a><br>iOS7之后苹果提供了 <coretelephony cttelephonynetworkinfo.h="">可以获取当前的网络状态（但是没找到wifi）</coretelephony></p>
<h1 id="二、监测网络状态"><a href="#二、监测网络状态" class="headerlink" title="二、监测网络状态"></a><strong>二、监测网络状态</strong></h1><p>Reachability的使用步骤<br>添加框架SystemConfiguration.framework</p>
<h2 id="1-点击项目，选择”Build-Phases”选项卡"><a href="#1-点击项目，选择”Build-Phases”选项卡" class="headerlink" title="(1) 点击项目，选择”Build Phases”选项卡"></a>(1) 点击项目，选择”Build Phases”选项卡</h2><h2 id="2-展开”Link-Binary-With-Libraries”并添加相应选项"><a href="#2-展开”Link-Binary-With-Libraries”并添加相应选项" class="headerlink" title="(2) 展开”Link Binary With Libraries”并添加相应选项"></a>(2) 展开”Link Binary With Libraries”并添加相应选项</h2><p><img src="http://ww1.sinaimg.cn/mw690/006yX0Ypgw1f9pu0wvs6lj30r40bkq4t.jpg" alt="导入系统库"></p>
<p>下载Reachability项目的压缩包，右击工程文件夹（注意不是总的那个项目文件）添加以下文件<br>添加Reachability.h 和 Reachability.m<br>在需要调用的m文件中包含相应头文件具体</p>
<p>#import “Reachability.h”</p>
<h1 id="具体实现的图文展示用了两个例子："><a href="#具体实现的图文展示用了两个例子：" class="headerlink" title="具体实现的图文展示用了两个例子："></a>具体实现的图文展示用了两个例子：</h1><p><img src="http://ww1.sinaimg.cn/mw690/006yX0Ypgw1f9pu0xchorg30ys0hjk1p.gif" alt="demo1"></p>
<p><img src="http://ww2.sinaimg.cn/mw690/006yX0Ypgw1f9pu0y42mpg30ys0hj7aq.gif" alt="demo2"></p>
<h1 id="自己思考的疑问点："><a href="#自己思考的疑问点：" class="headerlink" title="自己思考的疑问点："></a>自己思考的疑问点：</h1><h2 id="1、hostReachability与internetReachability的差异在哪？"><a href="#1、hostReachability与internetReachability的差异在哪？" class="headerlink" title="1、hostReachability与internetReachability的差异在哪？"></a>1、hostReachability与internetReachability的差异在哪？</h2><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">hostReachability:</span>主要指的是我们的移动网络,所以这里可以自己处理要移动网络还是不要</div><div class="line"></div><div class="line">internetReachability：</div><div class="line">只涵盖两种网络，</div><div class="line">有线网络（WWAn）,无线网络(Wifi)</div><div class="line">具体实现可以看我的demo</div></pre></td></tr></table></figure>
<h2 id="2、实现的时候注意，一定要把观察的对象作为属性，或者全局变量，不然使用完消失就观察不了（同样的例子适用于视频播放等等）"><a href="#2、实现的时候注意，一定要把观察的对象作为属性，或者全局变量，不然使用完消失就观察不了（同样的例子适用于视频播放等等）" class="headerlink" title="2、实现的时候注意，一定要把观察的对象作为属性，或者全局变量，不然使用完消失就观察不了（同样的例子适用于视频播放等等）"></a>2、实现的时候注意，一定要把观察的对象作为属性，或者全局变量，不然使用完消失就观察不了（同样的例子适用于视频播放等等）</h2><p><img src="http://ww4.sinaimg.cn/mw690/006yX0Ypgw1f9pu0zwyyyj30sl0dadky.jpg" alt="注意点"></p>
<p>本次讲解的Demo：<a href="https://github.com/OneHundredSir/Objective-C/tree/master/webtest" target="_blank" rel="external">GithubDemo</a></p>
<blockquote>
<p>作者信息</p>
</blockquote>
<p>如果有不足或者错误的地方还望各位读者批评指正，可以评论留言，笔者收到后第一时间回复。</p>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">具体信息</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">QQ/微信</td>
<td style="text-align:center">hundreda</td>
</tr>
<tr>
<td style="text-align:center">简书号连接</td>
<td style="text-align:center"><a href="http://www.jianshu.com/users/a3ae6d7c68b6/latest_articles" target="_blank" rel="external">iOS-香蕉大大</a></td>
</tr>
<tr>
<td style="text-align:center">GitHub个人开源主页</td>
<td style="text-align:center"><a href="https://github.com/OneHundredSir" target="_blank" rel="external">GitHub连接</a></td>
</tr>
<tr>
<td style="text-align:center">好心人赏我个<code>赞</code></td>
<td style="text-align:center"><code>欢迎各位前来查看，star,感谢各位的阅读</code></td>
</tr>
<tr>
<td style="text-align:center">个人iOS开发QQ讨论群</td>
<td style="text-align:center"><strong>365204530</strong></td>
</tr>
<tr>
<td style="text-align:center"><code>群内规矩</code></td>
<td style="text-align:center"><code>聊天扯淡，讨论技术都行，没有什么群规，不懂就问</code></td>
</tr>
<tr>
<td style="text-align:center">iOS开发类微信订阅号</td>
<td style="text-align:center"><strong>大大家的IOS说</strong></td>
</tr>
<tr>
<td style="text-align:center"><em>微信扫一扫下面二维码</em></td>
<td style="text-align:center"><code>一起用碎片时间学习IOS吧</code></td>
</tr>
</tbody>
</table>
<p><img src="http://upload-images.jianshu.io/upload_images/1730495-755d908f00d77cf8.gif?imageMogr2/auto-orient/strip" alt="微信个人技术订阅号"><br>喜欢的朋友可以赏我2块大洋买糖吃～你的打赏是我前进的动力~一起做一个乐于分享的人吧~</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/iOS进阶/">iOS进阶</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/iOS黑魔法/">iOS黑魔法</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/01/20/ios大大闭门造轮子/IOS开发[控件封装]---alertView封装/" title="IOS开发[控件封装]---alertView封装" itemprop="url">IOS开发[控件封装]---alertView封装</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Hundred Wang" target="_blank" itemprop="author">Hundred Wang</a>
		
  <p class="article-time">
    <time datetime="2016-01-19T22:49:50.000Z" itemprop="datePublished"> 发表于 2016-01-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="封装的效果图"><a href="#封装的效果图" class="headerlink" title="封装的效果图"></a>封装的效果图</h3><p><img src="http://upload-images.jianshu.io/upload_images/1730495-3a6e09448e13b0f4.gif?imageMogr2/auto-orient/strip" alt="效果图"></p>
<h3 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//让弹窗出现</span></div><div class="line"></div><div class="line">+ (<span class="keyword">void</span>) addHNotifierWithText : (<span class="built_in">NSString</span>* ) text dismissAutomatically : (<span class="built_in">BOOL</span>) shouldDismiss &#123;</div><div class="line">    <span class="comment">//get screen area</span></div><div class="line">    <span class="built_in">CGRect</span> screenBounds = APPDELEGATE.window.bounds;</div><div class="line">    </div><div class="line">    <span class="comment">//get width for given text</span></div><div class="line">    <span class="built_in">NSDictionary</span> *attributeDict = @&#123;<span class="built_in">NSFontAttributeName</span> : NOTIFIER_LABEL_FONT&#125;;</div><div class="line">    <span class="built_in">CGFloat</span> height = kLabelHeight;</div><div class="line">    <span class="built_in">CGFloat</span> width = <span class="built_in">CGFLOAT_MAX</span>;</div><div class="line">    <span class="built_in">CGRect</span> notifierRect = [text boundingRectWithSize:<span class="built_in">CGSizeMake</span>(width, height) options:<span class="built_in">NSStringDrawingUsesLineFragmentOrigin</span> attributes:attributeDict context:<span class="literal">NULL</span>];</div><div class="line">    </div><div class="line">    <span class="comment">//get xoffset width for the notifier view</span></div><div class="line">    <span class="built_in">CGFloat</span> notifierWidth = MIN(<span class="built_in">CGRectGetWidth</span>(notifierRect) + <span class="number">2</span>*xPadding, kMaxWidth);</div><div class="line">    <span class="built_in">CGFloat</span> xOffset = (<span class="built_in">CGRectGetWidth</span>(screenBounds) - notifierWidth)/<span class="number">2</span>;</div><div class="line">    </div><div class="line">    <span class="comment">//get height for notifier view.. Add cancel button height if not dismissing automatically</span></div><div class="line">    <span class="built_in">NSInteger</span> notifierHeight = kLabelHeight;</div><div class="line">    <span class="keyword">if</span>(!shouldDismiss) &#123;</div><div class="line">        notifierHeight += (kCancelButtonHeight+kSeparatorHeight);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">//get yOffset for notifier view</span></div><div class="line">    <span class="built_in">CGFloat</span> yOffset = <span class="built_in">CGRectGetHeight</span>(screenBounds) - notifierHeight - kHeightFromBottom;</div><div class="line">    </div><div class="line">    <span class="built_in">CGRect</span> finalFrame = <span class="built_in">CGRectMake</span>(xOffset, yOffset, notifierWidth, notifierHeight);</div><div class="line">    </div><div class="line">    <span class="built_in">UIView</span>* notifierView = [<span class="keyword">self</span> checkIfNotifierExistsAlready];</div><div class="line">    <span class="keyword">if</span>(notifierView) &#123;</div><div class="line">        <span class="comment">//update the existing notification here</span></div><div class="line">        [<span class="keyword">self</span> updateNotifierWithAnimation:notifierView withText:text completion:^(<span class="built_in">BOOL</span> finished) &#123;</div><div class="line">            <span class="built_in">CGRect</span> atLastFrame = finalFrame;</div><div class="line">            atLastFrame.origin.y = finalFrame.origin.y + <span class="number">8</span>;</div><div class="line">            notifierView.frame = atLastFrame;</div><div class="line">            </div><div class="line">            <span class="comment">//get the label and update its text and frame!</span></div><div class="line">            <span class="built_in">UILabel</span>* textLabel = <span class="literal">nil</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="built_in">UIView</span>* subview <span class="keyword">in</span> notifierView.subviews) &#123;</div><div class="line">                <span class="keyword">if</span>([subview isKindOfClass:[<span class="built_in">UILabel</span> <span class="keyword">class</span>]]) &#123;</div><div class="line">                    textLabel = (<span class="built_in">UILabel</span>* ) subview;</div><div class="line">                &#125;</div><div class="line">                </div><div class="line">                <span class="comment">//also remove separator and "cancel" button.. we may add it later if necessary</span></div><div class="line">                <span class="keyword">if</span>([subview isKindOfClass:[<span class="built_in">UIImageView</span> <span class="keyword">class</span>]] || [subview isKindOfClass:[<span class="built_in">UIButton</span> <span class="keyword">class</span>]]) &#123;</div><div class="line">                    [subview removeFromSuperview];</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            textLabel.text = text;</div><div class="line">            textLabel.frame = <span class="built_in">CGRectMake</span>(xPadding, <span class="number">0.0</span>, notifierWidth - <span class="number">2</span>*xPadding, kLabelHeight);</div><div class="line">            </div><div class="line">            <span class="comment">//if not dismissing</span></div><div class="line">            <span class="keyword">if</span>(!shouldDismiss) &#123;</div><div class="line">                <span class="comment">//first show a separator</span></div><div class="line">                <span class="built_in">UIImageView</span>* separatorImageView = [[<span class="built_in">UIImageView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0.0</span>, <span class="built_in">CGRectGetHeight</span>(textLabel.frame), <span class="built_in">CGRectGetWidth</span>(notifierView.frame), kSeparatorHeight)];</div><div class="line">                [separatorImageView setBackgroundColor:<span class="built_in">UIColorFromRGB</span>(<span class="number">0xF94137</span>)];</div><div class="line">                [notifierView addSubview:separatorImageView];</div><div class="line">                </div><div class="line">                <span class="comment">//now add that cancel button</span></div><div class="line">                <span class="built_in">UIButton</span>* buttonCancel = [<span class="built_in">UIButton</span> buttonWithType:<span class="built_in">UIButtonTypeCustom</span>];</div><div class="line">                buttonCancel.frame = <span class="built_in">CGRectMake</span>(<span class="number">0.0</span>, <span class="built_in">CGRectGetMaxY</span>(separatorImageView.frame), <span class="built_in">CGRectGetWidth</span>(notifierView.frame), kCancelButtonHeight);</div><div class="line">                [buttonCancel setBackgroundColor:<span class="built_in">UIColorFromRGB</span>(<span class="number">0x000000</span>)];</div><div class="line">                [buttonCancel addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(buttonCancelClicked:) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</div><div class="line">                [buttonCancel setTitle:<span class="string">@"Cancel"</span> forState:<span class="built_in">UIControlStateNormal</span>];</div><div class="line">                buttonCancel.titleLabel.font = NOTIFIER_CANCEL_FONT;</div><div class="line">                [notifierView addSubview:buttonCancel];</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            [<span class="built_in">UIView</span> animateWithDuration:<span class="number">0.4</span> delay:<span class="number">0.0</span> options:<span class="built_in">UIViewAnimationOptionCurveEaseInOut</span> animations:^&#123;</div><div class="line">                notifierView.alpha = <span class="number">1</span>;</div><div class="line">                notifierView.frame = finalFrame;</div><div class="line">            &#125; completion:^(<span class="built_in">BOOL</span> finished) &#123;</div><div class="line">            &#125;];</div><div class="line">        &#125;];</div><div class="line">        </div><div class="line">        <span class="keyword">if</span>(shouldDismiss) &#123;</div><div class="line">            [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(dismissHNotifier) withObject:<span class="literal">nil</span> afterDelay:<span class="number">2.0</span>];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        notifierView = [[<span class="built_in">UIView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(xOffset, <span class="built_in">CGRectGetHeight</span>(screenBounds), notifierWidth, notifierHeight)];</div><div class="line">        notifierView.backgroundColor = <span class="built_in">UIColorFromRGB</span>(<span class="number">0xF94137</span>);</div><div class="line">        notifierView.tag = kTagHAlertView;</div><div class="line">        notifierView.clipsToBounds = <span class="literal">YES</span>;</div><div class="line">        notifierView.layer.cornerRadius = <span class="number">5.0</span>;</div><div class="line">        [APPDELEGATE.window addSubview:notifierView];</div><div class="line">        [APPDELEGATE.window bringSubviewToFront:notifierView];</div><div class="line">        </div><div class="line">        <span class="comment">//create label which holds text inside the notifier view</span></div><div class="line">        <span class="built_in">UILabel</span>* textLabel = [[<span class="built_in">UILabel</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(xPadding, <span class="number">0.0</span>, notifierWidth - <span class="number">2</span>*xPadding, kLabelHeight)];</div><div class="line">        textLabel.adjustsFontSizeToFitWidth = <span class="literal">YES</span>;</div><div class="line">        textLabel.backgroundColor = [<span class="built_in">UIColor</span> clearColor];</div><div class="line">        textLabel.textAlignment = <span class="built_in">NSTextAlignmentCenter</span>;</div><div class="line">        textLabel.textColor = <span class="built_in">UIColorFromRGB</span>(<span class="number">0xFFFFFF</span>);</div><div class="line">        textLabel.font = NOTIFIER_LABEL_FONT;</div><div class="line">        textLabel.minimumScaleFactor = <span class="number">0.7</span>;</div><div class="line">        textLabel.text = text;</div><div class="line">        [notifierView addSubview:textLabel];</div><div class="line">        </div><div class="line">        <span class="keyword">if</span>(shouldDismiss) &#123;</div><div class="line">            [<span class="keyword">self</span> performSelector:<span class="keyword">@selector</span>(dismissHNotifier) withObject:<span class="literal">nil</span> afterDelay:<span class="number">2.0</span>];</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="comment">//not dismissng automatically... show cancel button to dismiss this alert</span></div><div class="line">            </div><div class="line">            <span class="comment">//first show a separator</span></div><div class="line">            <span class="built_in">UIImageView</span>* separatorImageView = [[<span class="built_in">UIImageView</span> alloc] initWithFrame:<span class="built_in">CGRectMake</span>(<span class="number">0.0</span>, <span class="built_in">CGRectGetHeight</span>(textLabel.frame), notifierWidth, kSeparatorHeight)];</div><div class="line">            [separatorImageView setBackgroundColor:<span class="built_in">UIColorFromRGB</span>(<span class="number">0xF94137</span>)];</div><div class="line">            [notifierView addSubview:separatorImageView];</div><div class="line">            </div><div class="line">            <span class="comment">//now add that cancel button</span></div><div class="line">            <span class="built_in">UIButton</span>* buttonCancel = [<span class="built_in">UIButton</span> buttonWithType:<span class="built_in">UIButtonTypeCustom</span>];</div><div class="line">            buttonCancel.frame = <span class="built_in">CGRectMake</span>(<span class="number">0.0</span>, <span class="built_in">CGRectGetMaxY</span>(separatorImageView.frame), notifierWidth, kCancelButtonHeight);</div><div class="line">            [buttonCancel setBackgroundColor:<span class="built_in">UIColorFromRGB</span>(<span class="number">0x000000</span>)];</div><div class="line">            [buttonCancel addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(buttonCancelClicked:) forControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>];</div><div class="line">            [buttonCancel setTitle:<span class="string">@"Cancel"</span> forState:<span class="built_in">UIControlStateNormal</span>];</div><div class="line">            buttonCancel.titleLabel.font = NOTIFIER_CANCEL_FONT;</div><div class="line">            [notifierView addSubview:buttonCancel];</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        [<span class="keyword">self</span> startEntryAnimation:notifierView withFinalFrame:finalFrame];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//让弹窗消失</span></div><div class="line"></div><div class="line">+ (<span class="keyword">void</span>) dismissHNotifier &#123;</div><div class="line">    </div><div class="line">    [<span class="built_in">NSObject</span> cancelPreviousPerformRequestsWithTarget:<span class="keyword">self</span> selector:<span class="keyword">@selector</span>(dismissHNotifier) object:<span class="literal">nil</span>];</div><div class="line">    </div><div class="line">    <span class="built_in">UIView</span>* notifier = <span class="literal">nil</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> (<span class="built_in">UIView</span>* subview <span class="keyword">in</span> [APPDELEGATE.window subviews]) &#123;</div><div class="line">        <span class="keyword">if</span>(subview.tag == kTagHAlertView &amp;&amp; [subview isKindOfClass:[<span class="built_in">UIView</span> <span class="keyword">class</span>]]) &#123;</div><div class="line">            notifier = subview;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    [<span class="keyword">self</span> startExitAnimation:notifier];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="demo下载"><a href="#demo下载" class="headerlink" title="demo下载"></a>demo下载</h3><p>Demo/封装的分类连接：<a href="https://github.com/OneHundredSir/Package/tree/master/%E8%87%AA%E5%B7%B1%E7%BB%84%E4%BB%B6%E9%97%AD%E9%97%A8%E9%80%A0%E8%BD%AE%E5%AD%90/AlertView" target="_blank" rel="external">提示框封装源码</a></p>
<blockquote>
<p>作者信息</p>
</blockquote>
<p>如果有不足或者错误的地方还望各位读者批评指正，可以评论留言，笔者收到后第一时间回复。</p>
<table>
<thead>
<tr>
<th style="text-align:center">名称</th>
<th style="text-align:center">具体信息</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">QQ/微信</td>
<td style="text-align:center">hundreda</td>
</tr>
<tr>
<td style="text-align:center">简书号连接</td>
<td style="text-align:center"><a href="http://www.jianshu.com/users/a3ae6d7c68b6/latest_articles" target="_blank" rel="external">iOS-香蕉大大</a></td>
</tr>
<tr>
<td style="text-align:center">GitHub个人开源主页</td>
<td style="text-align:center"><a href="https://github.com/OneHundredSir" target="_blank" rel="external">GitHub连接</a></td>
</tr>
<tr>
<td style="text-align:center">好心人赏我个<code>赞</code></td>
<td style="text-align:center"><code>欢迎各位前来查看，star,感谢各位的阅读</code></td>
</tr>
<tr>
<td style="text-align:center">个人iOS开发QQ讨论群</td>
<td style="text-align:center"><strong>365204530</strong></td>
</tr>
<tr>
<td style="text-align:center"><code>群内规矩</code></td>
<td style="text-align:center"><code>聊天扯淡，讨论技术都行，没有什么群规，不懂就问</code></td>
</tr>
<tr>
<td style="text-align:center">iOS开发类微信订阅号</td>
<td style="text-align:center"><strong>大大家的IOS说</strong></td>
</tr>
<tr>
<td style="text-align:center"><em>微信扫一扫下面二维码</em></td>
<td style="text-align:center"><code>一起用碎片时间学习IOS吧</code></td>
</tr>
</tbody>
</table>
<p><img src="http://upload-images.jianshu.io/upload_images/1730495-755d908f00d77cf8.gif?imageMogr2/auto-orient/strip" alt="微信个人技术订阅号"><br>喜欢的朋友可以赏我2块大洋买糖吃～你的打赏是我前进的动力~一起做一个乐于分享的人吧~</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    <footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/iOS入门/">iOS入门</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/工具/">工具</a><a href="/tags/iOS造轮子/">iOS造轮子</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>







  <nav id="page-nav" class="clearfix">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  
<div class="github-card">
<p class="asidetitle">Github 名片</p>
<div class="github-card" data-github="https://github.com/OneHundredSir" data-width="220" data-height="119" data-theme="medium">
<script type="text/javascript" src="//cdn.jsdelivr.net/github-cards/latest/widget.js" ></script>
</div>
  </div>



  
<div class="categorieslist">
	<p class="asidetitle">分类</p>
		<ul>
		
		  
			<li><a href="/categories/iOS入门/" title="iOS入门">iOS入门<sup>5</sup></a></li>
		  
		
		  
			<li><a href="/categories/iOS进阶/" title="iOS进阶">iOS进阶<sup>11</sup></a></li>
		  
		
		  
		
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/iOS黑魔法/" title="iOS黑魔法">iOS黑魔法<sup>11</sup></a></li>
			
		
			
				<li><a href="/tags/iOS项目/" title="iOS项目">iOS项目<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/iOS进阶拓展/" title="iOS进阶拓展">iOS进阶拓展<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/blockKit/" title="blockKit">blockKit<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/项目仿写/" title="项目仿写">项目仿写<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/iOS开发/" title="iOS开发">iOS开发<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/iOS热更新/" title="iOS热更新">iOS热更新<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/runtime/" title="runtime">runtime<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/iOS工具/" title="iOS工具">iOS工具<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/iOS造轮子/" title="iOS造轮子">iOS造轮子<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/工具/" title="工具">工具<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/iOS拓展资料/" title="iOS拓展资料">iOS拓展资料<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://coderq.com" target="_blank" title="一个面向程序员交流分享的新一代社区">码农圈</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=b3593ceb&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 成长之路,厚积薄发 <br/>
			一起成长QQ群:365204530,微信技术公众号:大大家的IOS说</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/http://http://weibo.com/hundredWin" target="_blank" class="icon-weibo" title="微博"></a>
		
		
		<a href="https://github.com/https://github.com/OneHundredSir" target="_blank" class="icon-github" title="github"></a>
		
		
		
		
		
		
		
		
		
		<a href="mailto:15507596877@139.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2016 
		
		<a href="/about" target="_blank" title="Hundred Wang">Hundred Wang</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?e6d1f421bbc9962127a50488f9ed37d1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
